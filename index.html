<!DOCTYPE html>
<html lang="it" data-theme="auto">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>17/19 Urban Bistrot</title>
  <meta name="description" content="17/19 Urban Bistrot Roma.Colazioni, pranzi, cene e cocktailS. Location per eventi privati." />
  <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">
  <meta name="theme-color" content="#0b0b0b" media="(prefers-color-scheme: dark)">
  <!-- favicon di fallback -->
  <link rel="icon" type="image/svg+xml"
        href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' rx='12' fill='%230b0b0b'/%3E%3Ctext x='50%25' y='54%25' dominant-baseline='middle' text-anchor='middle' font-family='Montserrat,Arial' font-size='28' fill='%23fff'%3E17%2F19%3C/text%3E%3C/svg%3E" />
  <!-- favicon dal logo -->
  <link rel="icon" type="image/svg+xml" href="https://cdn.shopify.com/s/files/1/0887/8332/3459/files/1719logobianco.svg?v=1755104086">

  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&family=Montserrat:wght@700;800;900&display=swap" rel="stylesheet"/>

  <style>
    :root{
      --menu-blur: 18px; --menu-dim: 0.68;
      --bg:#ffffff; --fg:#0b0b0b; --muted:#6b7280; --line:#e5e7eb;
      --accent:#c23331; --accent-fg:#ffffff;
      --chip:#c23331; --chip-fg:#0b0b0b;
      --radius:16px; --pad:clamp(16px,4vw,32px); --max:1120px;
      --header-h:64px;
    }
    @media (prefers-color-scheme: dark){
      html[data-theme="auto"]{
        --bg:#0b0b0b; --fg:#ffffff; --muted:#9ca3af; --line:#1f1f1f;
        --chip:#121212; --chip-fg:#e5e7eb;
      }
    }
    @media (prefers-color-scheme: light){
  html[data-theme="auto"]{
    --bg:#ffffff; --fg:#0b0b0b; --muted:#6b7280; --line:#e5e7eb;
    --chip:#f4f4f5; --chip-fg:#0b0b0b;
  }
}

    html[data-theme="light"]{
      --bg:#ffffff; --fg:#0b0b0b; --muted:#6b7280; --line:#e5e7eb;
      --chip:#f4f4f5; --chip-fg:#0b0b0b;
    }
    html[data-theme="dark"]{
      --bg:#0b0b0b; --fg:#ffffff; --muted:#9ca3af; --line:#1f1f1f;
      --chip:#121212; --chip-fg:#e5e7eb;
    }

    *{box-sizing:border-box} html,body{margin:0}
    body{background:var(--bg);color:var(--fg);font-family:'Inter',system-ui,sans-serif;line-height:1.6}
    img{max-width:100%;display:block}
    .container{max-width:var(--max);margin-inline:auto;padding-inline:var(--pad)}
    section{padding:20px 0}
    .grid{display:grid;gap:16px}
    .grid-2{grid-template-columns:1fr}
    .grid-3{grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}
    .only-desktop{display:none} .only-mobile{display:inline-flex}
    @media (min-width:768px){ .grid-2{grid-template-columns:1.2fr .8fr} .only-desktop{display:inline-flex} .only-mobile{display:none} }

    /* Header */
    header{position:fixed;top:0;left:0;right:0;background:transparent;border-bottom:0;z-index:100}
    header.header--solid{background:color-mix(in oklab, var(--bg) 85%, transparent);border-bottom:1px solid var(--line);backdrop-filter:saturate(140%) blur(8px)}
    nav{display:flex;align-items:center;justify-content:space-between;height:var(--header-h)}
    .brand{display:flex;align-items:center;gap:12px;text-decoration:none;color:inherit}
    .brand img{height:48px;width:auto} @media (min-width:768px){ .brand img{height:56px} }
    .logo-dark{display:none}.logo-light{display:inline}
    html[data-theme="dark"] .logo-light{display:none} html[data-theme="dark"] .logo-dark{display:inline}
    html[data-theme="light"] .logo-light{display:inline} html[data-theme="light"] .logo-dark{display:none}
    @media (prefers-color-scheme: dark){ html[data-theme="auto"] .logo-light{display:none} html[data-theme="auto"] .logo-dark{display:inline} }
    @media (prefers-color-scheme: light){ html[data-theme="auto"] .logo-light{display:inline} html[data-theme="auto"] .logo-dark{display:none} }
    .nav-desktop{display:none;gap:12px;align-items:center;list-style:none;margin:0;padding:0}
    .nav-desktop a{color:var(--fg);text-decoration:none;font-weight:700;opacity:.86}
    .nav-desktop a:hover{opacity:1}
    @media (min-width:768px){ .nav-desktop{display:flex} }
    .pill{display:inline-flex;align-items:center;gap:.55rem;padding:.55rem .9rem;border:1px solid var(--line);border-radius:999px;text-decoration:none;font-weight:800;background:var(--chip);color:var(--chip-fg)}
    .pill--accent{background:var(--accent);border-color:var(--accent);color:var(--accent-fg)}
    .pill--ghost{background:transparent} .pill--disabled{opacity:.55;pointer-events:none}
    .pill:where(:hover,:focus-visible){transform:translateY(-1px);transition:transform .15s ease}
    .toggle{width:40px;height:40px;border:1px solid var(--line);border-radius:12px;background:var(--chip);color:var(--chip-fg);display:grid;place-items:center;cursor:pointer}
    .menu-toggle{width:44px;height:44px;border:1px solid var(--line);border-radius:12px;background:var(--chip);display:grid;place-items:center;cursor:pointer}
    .menu-toggle span,.menu-toggle span::before,.menu-toggle span::after{display:block;width:18px;height:2px;background:var(--fg);content:"";position:relative}
    .menu-toggle span::before{position:absolute;top:-6px} .menu-toggle span::after{position:absolute;top:6px}

    /* Fullscreen sheet */
    .sheet{position:fixed; inset:0; background:rgba(0,0,0,.68); opacity:0; pointer-events:none; z-index:999; transition:opacity .25s ease; backdrop-filter: blur(18px) saturate(120%); color:#fff;}
    .sheet.active{opacity:1; pointer-events:auto}
    .sheet__panel{position:absolute; inset:0; display:grid; grid-template-rows:auto 1fr; align-items:start}
    .sheet__close{position:absolute; top:14px; right:14px; width:44px; height:44px; border-radius:12px; border:1px solid rgba(255,255,255,.25); background:rgba(255,255,255,.10); color:#fff; font-size:24px; font-weight:900; display:grid; place-items:center; cursor:pointer; z-index:1000; touch-action:manipulation;}
    .sheet__inner{display:grid; place-items:center; height:100%; padding:28px; opacity:.0; transform: translateY(6px) scale(.99); overflow:auto}
    .sheet__list{list-style:none;margin:0;padding:0;display:grid;gap:14px;text-align:center}
    .sheet__list a{display:block;padding:10px 14px;border-radius:14px;text-decoration:none;color:#fff;font-weight:900;font-size:clamp(1.4rem,5vw,2.4rem);letter-spacing:.04em}
    .sheet__list a:hover{ background:rgba(255,255,255,.08) }
    .sheet__cta{display:inline-flex;margin-top:18px}
    .sheet.active .sheet__inner{opacity:1; transform:none; transition: opacity .25s ease .06s, transform .25s ease .06s}
    .sheet.active .sheet__list a{ animation: menuStagger .28s ease both }
    .sheet.active .sheet__list li:nth-child(1) a{animation-delay:.05s} .sheet.active .sheet__list li:nth-child(2) a{animation-delay:.09s}
    .sheet.active .sheet__list li:nth-child(3) a{animation-delay:.13s} .sheet.active .sheet__list li:nth-child(4) a{animation-delay:.17s}
    .sheet.active .sheet__list li:nth-child(5) a{animation-delay:.21s} .sheet.active .sheet__list li:nth-child(6) a{animation-delay:.25s}
    @keyframes menuStagger{from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:translateY(0)}}
    body.menu-open{overflow:hidden} body.menu-open > :not(.sheet){filter: blur(10px) saturate(1.06); transition: filter .25s ease; transform: translateZ(0)}

    /* Hero */
    .hero{padding:72px 0 24px}
    .tag{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--line);border-radius:999px;padding:6px 10px;font-weight:800;color:var(--chip-fg)}
    h1{font-family:'Montserrat',system-ui,sans-serif;font-weight:900;text-transform:uppercase;letter-spacing:.01em;font-size:clamp(2.1rem,8vw,3.6rem);line-height:1.1;margin:12px 0 10px}
    .lead{color:var(--fg);font-size:clamp(1rem,4.5vw,1.18rem);margin:8px 0 14px}
    .hero-media{position:relative;border:1px solid var(--line);border-radius:16px;overflow:hidden;aspect-ratio:4/5;background:var(--chip);margin-top:14px}
    @media (min-width:768px){ .hero-media{aspect-ratio:16/9;margin-top:18px} }
    .slide{position:absolute;inset:0;opacity:0;transition:opacity .35s}
    .slide.active{opacity:1}
    .dots{position:absolute;left:0;right:0;bottom:8px;display:flex;gap:6px;justify-content:center}
    .dot{width:8px;height:8px;border-radius:999px;background:#a1a1aa;border:1px solid #00000020;cursor:pointer;opacity:.85}
    .dot.active{background:#fff;opacity:1}

    /* Cards */
    .card{border:1px solid var(--line);border-radius:16px;padding:16px;background:color-mix(in oklab, var(--bg) 96%, transparent)}
    .block-title{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
    .block-title h3{font-family:'Montserrat',system-ui,sans-serif;font-size:1rem;margin:0;letter-spacing:.02em}
    .meta{color:var(--muted);font-size:.95rem}
    .hero-right{display:grid;gap:12px}

    /* Mini time cards */
    .time-cards{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-top:6px}
    .time-card{display:flex;align-items:center;justify-content:space-between;gap:10px;border:1px solid var(--line);border-radius:14px;padding:10px 12px;background:color-mix(in oklab, var(--bg) 98%, transparent)}
    .time-card .l{display:flex;align-items:center;gap:8px}
    .time-card .i{display:grid;place-items:center;width:28px;height:28px;border-radius:10px;background:var(--chip);border:1px solid var(--line)}

    /* Menu accordion */
    .badge{display:inline-block;background:var(--accent);color:var(--accent-fg);padding:6px 10px;border-radius:999px;font-size:.75rem;font-weight:900}
    details.menu-acc{border:1px solid var(--line);border-radius:16px;background:color-mix(in oklab, var(--bg) 96%, transparent);padding:12px}
    details.menu-acc + details.menu-acc{margin-top:12px}
    details.menu-acc[open]{background:color-mix(in oklab, var(--bg) 98%, transparent)}
    summary.menu-sum{list-style:none;display:flex;align-items:center;gap:10px;cursor:pointer}
    summary.menu-sum::-webkit-details-marker{display:none}
    .menu-sum h3{margin:8px 0 0;font-family:'Montserrat',system-ui,sans-serif}
    .menu-sum .chev{margin-left:auto;transition:transform .2s}
    details[open] .menu-sum .chev{transform:rotate(180deg)}
    .menu-body{padding:8px 4px 2px}
    .group-title{margin:8px 0 4px;font-weight:800}
    .menu-item{display:flex;justify-content:space-between;gap:10px;padding:10px 0;border-bottom:1px dashed var(--line)}
    .menu-item .mi-right{display:flex;flex-direction:column;align-items:flex-end;gap:6px}
    .menu-item:last-child{border-bottom:0}
    .price{color:var(--accent);font-weight:800}

    /* Events */
    .event{position:relative;display:grid;gap:10px;align-items:start;border:1px solid var(--line);border-radius:16px;padding:14px;background:color-mix(in oklab, var(--bg) 96%, transparent);transition:box-shadow .2s, transform .2s, border-color .2s; touch-action:manipulation; user-select:none; -webkit-user-select:none}
    .event__title{font-weight:900}
    .event__top{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .event__date{min-width:66px;text-align:center;border:1px solid var(--line);border-radius:12px;padding:8px 10px;background:var(--chip)}
    .event__dow{font-weight:900} .event__day{font-size:1.4rem;font-weight:900;line-height:1}
    .event__info{display:flex;flex-wrap:wrap;gap:8px;color:var(--muted);font-size:.95rem}
    .event__names{display:flex;flex-wrap:wrap;gap:8px;margin-top:4px; user-select:none; -webkit-user-select:none}
    .event__sponsors{display:none; gap:8px; flex-wrap:wrap; margin-top:6px; user-select:none; -webkit-user-select:none}
    .event--show-sponsors .event__sponsors{display:flex}
    .events-more{display:flex;justify-content:center;margin-top:10px}
    .event__actions{display:flex; gap:8px; flex-wrap:wrap}

    .event--voted{
      border-color: color-mix(in oklab, var(--accent) 65%, transparent);
      box-shadow: 0 0 0 1px color-mix(in oklab, var(--accent) 35%, transparent) inset, 0 6px 18px rgba(255,31,61,.22);
      animation: upPulse 1.2s ease-in-out infinite alternate;
    }
    @keyframes upPulse{
      from{ box-shadow: 0 0 0 1px rgba(255,31,61,.26) inset, 0 4px 14px rgba(255,31,61,.18) }
      to  { box-shadow: 0 0 0 1px rgba(255,31,61,.36) inset, 0 8px 22px rgba(255,31,61,.24) }
    }
          /* Micro-animazione quando si fa upvote su una card */
      @keyframes cardPopShake{
        0%   { transform: scale(1) translateX(0) rotate(0); }
        12%  { transform: scale(1.03) translateX(-1.5px) rotate(-0.3deg); }
        24%  { transform: scale(1.03) translateX(1.5px)  rotate(0.3deg); }
        36%  { transform: scale(1.02) translateX(-1px)   rotate(-0.2deg); }
        48%  { transform: scale(1.02) translateX(1px)    rotate(0.2deg); }
        60%  { transform: scale(1.01) translateX(0.5px)  rotate(0); }
        100% { transform: scale(1) translateX(0) rotate(0); }
      }
      .event{ will-change: transform; }
      .event--burst{ animation: cardPopShake .6s cubic-bezier(.2,.8,.2,1); }

    .vote-badge{position:absolute; top:8px; right:8px; font-weight:900; background:color-mix(in oklab, var(--bg) 92%, transparent); border:1px solid var(--line); border-radius:999px; padding:4px 8px; font-size:.9rem; display:inline-flex; align-items:center; gap:6px}
    .icon{width:16px; height:16px; display:inline-block; vertical-align:middle}
    .share-pop{ position:absolute; z-index:50; background:color-mix(in oklab, var(--bg) 96%, transparent); border:1px solid var(--line); border-radius:10px; padding:8px; display:none; gap:6px; }
    .share-pop button, .share-pop a{ border:1px solid var(--line); background:var(--chip); color:var(--chip-fg); border-radius:8px; padding:6px 8px; text-decoration:none; font-weight:800; font-size:.9rem; }

    /* Name chips */
    .name-chip{display:inline-flex; align-items:center; gap:6px; padding:.18rem .46rem; border:1px dashed var(--line); border-radius:12px; font-weight:800; letter-spacing:.04em; background:color-mix(in oklab, var(--bg) 98%, transparent); user-select:none; -webkit-user-select:none; touch-action:manipulation}

    /* Poster + Bouncers */
    .poster-frame{position:relative;border:1px solid var(--line);border-radius:20px;background:var(--bg);overflow:hidden}
    .poster-inner{position:relative;padding:clamp(18px,4vw,28px)}
    .poster-head{display:flex;flex-direction:column;align-items:center;text-align:center;gap:6px; user-select:none; -webkit-user-select:none}
    .poster-head .venue{font-weight:900;letter-spacing:.10em;text-transform:uppercase;font-size:clamp(.9rem,1.8vw,1rem)}
    .poster-head .series{font-family:'Montserrat',system-ui,sans-serif;font-weight:900;letter-spacing:.06em;text-transform:uppercase;font-size:clamp(2rem,6.5vw,3.1rem);line-height:1.05}
    .poster-head .date{font-weight:900;letter-spacing:.10em;text-transform:uppercase;font-size:clamp(.95rem,3.5vw,1.2rem)}
    .poster-head .tagline{margin-top:4px;font-weight:900;letter-spacing:.10em;text-transform:uppercase;color:var(--fg);font-size:clamp(.82rem,2.2vw,.96rem)}
    .poster-head .curated{color:var(--muted);font-weight:700;letter-spacing:.08em;text-transform:uppercase;font-size:clamp(.78rem,2vw,.9rem)}
    .poster-canvas{position:relative;margin-top:clamp(16px,3.2vw,26px);height:clamp(320px,56vw,480px);background:color-mix(in oklab, var(--chip) 94%, transparent);border:1px solid var(--line);border-radius:14px;overflow:hidden}
    .poster-canvas canvas.trail{ position:absolute; inset:0; pointer-events:none; z-index:1 }
    .poster-logos{position:relative; padding:10px 10px 0; border-top:0; display:flex; gap:12px; justify-content:center; align-items:center; flex-wrap:wrap; row-gap:6px; user-select:none; -webkit-user-select:none}
    .poster-logos span.poster-sponsor{ font-weight:900; letter-spacing:.12em; font-size:.72rem; opacity:.95 }
    .bouncer{position:absolute;display:inline-flex;align-items:center;gap:10px;padding:.16em .44em;border-radius:6px;font-weight:900;letter-spacing:.06em;text-transform:uppercase;white-space:nowrap;will-change:transform;box-shadow:0 0 0 1px var(--line) inset;background:color-mix(in oklab, var(--bg) 96%, transparent);user-select:none; -webkit-user-select:none; touch-action:manipulation; z-index:2;}
    .bouncer .dot{display:inline-block;width:6px;height:6px;border-radius:2px;background:var(--fg);margin-right:2px;vertical-align:middle}
    .bouncer .rc{display:none !important; align-items:center; gap:6px; padding:.1rem .4rem; border-radius:999px; border:1px solid var(--line); background:color-mix(in oklab, var(--bg) 96%, transparent); font-weight:900}
    .bouncer .lbl{ transition: color .2s }
    .bouncer.up-lit .lbl{ color: var(--accent); text-shadow: 0 0 10px color-mix(in oklab, var(--accent) 40%, transparent) }

    /* Map */
    .map{border:1px solid var(--line);border-radius:16px;overflow:hidden}
    .map iframe{width:100%;height:320px;border:0;display:block}
    @media (min-width:768px){ .map iframe{height:360px} }

    /* Footer + FAB */
    footer{border-top:1px solid var(--line);padding:28px 0;color:var(--muted);text-align:center}
    .fab{position:fixed;right:16px;bottom:16px;width:56px;height:56px;border-radius:999px;background:var(--accent);display:grid;place-items:center;box-shadow:0 10px 22px rgba(0,0,0,.15);text-decoration:none;z-index:80}
    .fab svg{width:26px;height:26px}
    .fab path{fill:var(--accent-fg)}

    /* Reveal */
    .reveal{opacity:0;transform:translateY(16px);transition:opacity .5s ease, transform .5s ease}
    .reveal.active{opacity:1;transform:translateY(0)}

    /* Mobile overflow */
    html,body{max-width:100%; overflow-x:hidden;}
    .tag{ max-width:100%; white-space:normal; flex-wrap:wrap; overflow-wrap:anywhere; }
    .poster-logos{flex-wrap:wrap; row-gap:6px;}
    @media (max-width:420px){ .time-cards{grid-template-columns:1fr;} }

    /* Toast: ridisegnata come card persistente */
    .toast{
      position:fixed;
      left:50%;
      top:calc(var(--header-h) + 12px);
      transform:translateX(-50%) translateY(-8px);
      width:min(var(--max), calc(100% - 24px));
      background:color-mix(in oklab, var(--bg) 96%, transparent);
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px 14px;
      box-shadow:0 12px 28px rgba(0,0,0,.18);
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:400;
      z-index:1100;
      opacity:0;
      pointer-events:none;
      transition:opacity .18s ease, transform .18s ease;
      flex-direction: column;
    }
    .toast.show{ opacity:1; pointer-events:auto; transform:translateX(-50%) translateY(0) }
    .toast .meta{ opacity:.95 }
    .toast .x{
      margin-left:auto;
      border:1px solid var(--line);
      background:var(--chip);
      color:var(--chip-fg);
      padding:6px 10px;
      border-radius:10px;
      font-weight:900;
      cursor:pointer;
    }
    .toast .k{ font-weight:900; opacity:.95; }
  
    /* Extra helpers */
    .pill--wide{ padding:.66rem 1rem; font-weight:900; }
    #menuAccordions{ grid-template-columns:1fr; }
    @media (min-width:980px){ #menuAccordions{ grid-template-columns:1fr 1fr; } }
    /* Camera icon + modal */
    .photo-btn{ display:inline-flex; align-items:center; gap:6px; border:1px solid var(--line); background:var(--chip); color:var(--chip-fg);
      border-radius:999px; padding:3px 8px; font-weight:800; font-size:.8rem; margin-left:8px; cursor:pointer; }
    .photo-btn svg{ width:14px; height:14px; }
    .modal{position:fixed;inset:0;display:grid;place-items:center;background:rgba(0,0,0,.55);z-index:1200;opacity:0;visibility:hidden;transition:opacity .18s ease;will-change:opacity}
    .modal.show{opacity:1;visibility:visible}
    .modal__body{ position:relative; background:var(--bg); border:1px solid var(--line); border-radius:16px;
      max-width:min(920px, 96vw); max-height:90vh; padding:10px; }
    .modal__body img{ display:block; max-width:100%; max-height:72vh; border-radius:12px; }
    .modal__close{ position:absolute; right:10px; top:10px; width:40px; height:40px; border-radius:12px;
      border:1px solid var(--line); background:var(--chip); color:var(--chip-fg); font-size:22px; font-weight:900; cursor:pointer; }
    .modal__caption{ margin-top:6px; text-align:center; }

    /* Private Events Section */
    .private-events{
      background:color-mix(in oklab, var(--accent) 5%, transparent);
      border:1px solid color-mix(in oklab, var(--accent) 20%, transparent);
      border-radius:16px;
      padding:20px;
      margin-top:16px;
    }
    .private-events h4{
      margin:0 0 12px;
      font-family:'Montserrat',system-ui,sans-serif;
      font-weight:900;
      color:var(--accent);
    }
    .private-events-grid{
      display:grid;
      gap:8px;
      margin:12px 0;
    }
    .private-events-grid span{
      display:flex;
      align-items:center;
      gap:8px;
      font-weight:600;
    }

  
  /* === Global red loader (ring) === */
  .loader--ring{ --s:22px; --w:3px; width:var(--s); height:var(--s); border-radius:50%; display:inline-block;
    border:var(--w) solid color-mix(in oklab, var(--accent) 26%, transparent);
    border-top-color:var(--accent); animation:spin .8s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .loader-overlay{ position:absolute; inset:0; display:grid; place-items:center; pointer-events:none; opacity:1; transition:opacity .18s ease }
  .loader-overlay.hidden{ opacity:0 }

  /* === Modal: remove layout toggling to avoid white flash; animate opacity/visibility === */
  .modal{ position:fixed; inset:0; display:grid; place-items:center; background:rgba(0,0,0,.55);
    z-index:1200; opacity:0; visibility:hidden; transition:opacity .18s ease; will-change:opacity; }
  .modal.show{ opacity:1; visibility:visible; }
  .modal__body{ position:relative; background:var(--bg); border:1px solid var(--line); border-radius:16px;
    max-width:min(920px,96vw); max-height:90vh; padding:10px; will-change:transform; transform:translateZ(0); }
  .modal__body img{ display:block; max-width:100%; max-height:72vh; border-radius:12px; }
  .modal__close{ position:absolute; right:10px; top:10px; width:40px; height:40px; border-radius:12px;
    border:1px solid var(--line); background:var(--chip); color:var(--chip-fg); font-size:22px; font-weight:900; cursor:pointer; }
  .modal__caption{ margin-top:6px; text-align:center; }

  /* === Carousel: smoother crossfade, no flash === */
  .live-box{ position:relative; overflow:hidden; border:1px solid var(--line); border-radius:16px; background:color-mix(in oklab, var(--bg) 96%, transparent); }
  #liveCarousel .slide{ position:absolute; inset:0; opacity:0; transform:scale(1.01) translateZ(0); transition:opacity .4s ease, transform .4s ease; will-change:opacity,transform; backface-visibility:hidden; }
  #liveCarousel .slide.active{ opacity:1; transform:scale(1) translateZ(0); }
  #liveDots{ position:absolute; left:50%; bottom:10px; transform:translateX(-50%); display:flex; gap:6px; z-index:2; }
  #liveDots .dot{ width:8px; height:8px; border-radius:50%; background:color-mix(in oklab, var(--fg) 24%, transparent); border:0; cursor:pointer; }
  #liveDots .dot.active{ background:var(--fg); }

  /* More responsive animation helper */
  @media (prefers-reduced-motion: reduce){
    .reveal, #liveCarousel .slide{ transition:none !important }
    .modal{ transition:none !important }
  }

</style>

    
<style id="visual-hotfixes-v7e">
:root{ --accent:#c23331; --accent-fg:#ffffff; }
html{ scrollbar-gutter: stable both-edges; }
html.modal-open, body.modal-open{ overflow: hidden; }
.modal{ contain:paint; backface-visibility:hidden; }
.modal .modal-inner{ transform: translateZ(0); will-change: transform, opacity; }
.modal img[data-photo]{ display:block; width:100%; height:100%; object-fit:cover; image-rendering:auto; }
.modal[data-state="loading"] img[data-photo]{ opacity:0; }
.modal[data-state="loaded"] img[data-photo]{ opacity:1; transition: opacity .2s ease; }
.modal .spinner{ position:absolute; inset:auto; left:50%; top:50%; transform:translate(-50%,-50%); width:64px; height:64px; opacity:0; transition:opacity .2s ease; }
.modal[data-state="loading"] .spinner{ opacity:1; }
.modal .close-btn{ position:absolute; right:10px; top:10px; background:rgba(0,0,0,.5); color:#fff; border:0; border-radius:999px; width:40px; height:40px; display:grid; place-items:center; cursor:pointer; }
.modal .photo-frame{ max-width:min(92vw,1080px); max-height:min(86vh,1080px); width:clamp(280px,86vw,1080px); aspect-ratio:4/3; border-radius:16px; overflow:hidden; position:relative; background:rgba(0,0,0,.18); box-shadow:0 10px 30px rgba(0,0,0,.35); }
.hero-carousel, [data-carousel]{ contain:paint; backface-visibility:hidden; }
.hero-carousel .track, [data-carousel] .track, [data-carousel][data-track]{ will-change: transform; transform: translate3d(var(--x,0),0,0); transition: transform .28s ease; }
.hero-carousel img, [data-carousel] img{ content-visibility:auto; contain-intrinsic-size:auto 300px; }
img[loading="lazy"]{ decoding:async; }
@media (prefers-reduced-motion: reduce){
  .hero-carousel .track, [data-carousel] .track, [data-carousel][data-track]{ transition:none !important; }
  .modal *{ transition:none !important; }
}
</style>
<style id="hero-ios-fixes-v1">
/* ===== Responsive hero fixes (iPhone mini / iPhone 16 Pro Max) ===== */

/* Spaziatura hero che considera l’header fisso */
.hero{ padding: calc(var(--header-h) + 8px) 0 20px; }

/* Evita “salti” e overflow tra poster e live carousel */
.poster-frame{ margin-bottom: 12px; }

/* Mobile “universale” fino a 430px (iPhone mini compresi) */
@media (max-width: 430px){
  /* Poster canvas: scala in base alla finestra reale, senza sballare */
  .poster-canvas{
    /* priorità alle unità dinamiche per iOS Safari */
    height: min(58dvh, 120vw, 560px);
  }
  /* Live carousel più verticale per schermi stretti */
  .hero-media{ aspect-ratio: 3 / 4; }
}

/* Ultra-compact (alcuni mini / zoom display) */
@media (max-width: 360px){
  h1{ font-size: clamp(1.9rem, 7.5vw, 2.6rem); }
  .poster-head .series{ font-size: clamp(1.6rem, 9vw, 2.4rem); }
  .poster-head .date{ font-size: clamp(.82rem, 3.8vw, 1rem); }
  .tag{ font-size: .9rem; }
}

/* 431–480px (iPhone 16/16 Pro/Max in modalità più “wide”) */
@media (min-width: 431px) and (max-width: 480px){
  .poster-canvas{ height: min(64dvh, 110vw, 600px); }
  /* qui va bene 4:5, mantiene coerenza con poster verticale */
  .hero-media{ aspect-ratio: 4 / 5; }
}

/* iOS Safari: piccole correzioni “solo iPhone” */
@supports (-webkit-touch-callout: none){
  /* Evita che la barra URL causi ricalcoli bruschi */
  .sheet, .poster-canvas, .hero-media{
    contain: layout paint;
    backface-visibility: hidden;
    transform: translateZ(0);
  }
}
</style>


</head>
<body>
  <!-- Header -->
  <header>
    <div class="container">
      <nav aria-label="principale">
        <a class="brand" href="#">
          <img class="logo-light" src="https://cdn.shopify.com/s/files/1/0887/8332/3459/files/1719logooo.svg?v=1755102480" alt="17/19 Urban Bistrot - Logo"/>
          <img class="logo-dark"  src="https://cdn.shopify.com/s/files/1/0887/8332/3459/files/1719logobianco.svg?v=1755104086" alt="17/19 Urban Bistrot - Logo (dark)"/>
        </a>

        <ul class="nav-desktop">
          <li><a href="#about">About</a></li>
          <li><a href="#menu">Menu</a></li>
          <li><a href="#events">Eventi</a></li>
          <li><a href="#contact">Contatti</a></li>
          <li><a href="#private">Eventi Privati</a></li>
          <li><a class="pill pill--accent" href="#menu">Menù</a></li>
          <li><a class="pill pill--accent" href="https://wa.me/393298252092?text=Ciao%2017%2F19%20Urban%20Bistrot%2C%20vorrei%20prenotare" target="_blank" rel="noopener">Prenota</a></li>
          <li><button id="themeToggle" class="toggle" aria-label="Tema: automatico"></button></li>
          <li><button class="menu-toggle" id="menuToggleD" aria-label="Apri/chiudi menu"><span></span></button></li>
        </ul>

        <div class="only-mobile" style="gap:8px;align-items:center">
          <a href="#menu" class="pill pill--accent pill--wide" aria-label="Vai al menù">Menù</a>
          <button id="themeToggleM" class="toggle" aria-label="Tema: automatico"></button>
          <button class="menu-toggle" id="menuToggle" aria-label="Apri/chiudi menu"><span></span></button>
        </div>
      </nav>
    </div>
  </header>

  <!-- Fullscreen Site Menu -->
  <div class="sheet" id="siteMenu" role="dialog" aria-hidden="true" aria-modal="true" aria-label="menu sito">
    <div class="sheet__panel">
      <button class="sheet__close" id="sheetClose" type="button" aria-label="Chiudi menu">×</button>
      <div class="sheet__inner">
        <ul class="sheet__list">
          <li><a href="#about">About</a></li>
          <li><a href="#menu">Menu</a></li>
          <li><a href="#music">Musica</a></li>
          <li><a href="#events">Eventi</a></li>
          <li><a href="#private">Eventi Privati</a></li>
          <li><a href="#contact">Contatti</a></li>
        </ul>
        <a class="pill pill--accent sheet__cta" href="https://wa.me/393298252092?text=Ciao%2017%2F19%20Urban%20Bistrot%2C%20vorrei%20prenotare" target="_blank" rel="noopener">Prenota</a>
      </div>
    </div>
  </div>

  <div id="tipsToast" class="toast" role="region" aria-live="polite" aria-label="Interazioni">
    <div style="display:flex;align-items:center;gap:8px">
      <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true"><path d="M12 3l7 7h-4v11H9V10H5l7-7z" fill="currentColor"/></svg>
      <strong>Interazioni</strong>
    </div>
    <div class="meta">
      Fai <strong>doppio tap</strong> per interagire con il nome dell'artista o sulla data dell'evento🔥<br/>
      Tante interazioni = tanto supporto!
    </div>
    <button class="x" aria-label="Chiudi">Chiudi</button>
  </div>

  <!-- Hero: Poster/Live Shots + Orari + About card -->
  <section class="hero">
    <div class="container grid grid-2">
      <!-- Colonna sinistra: poster o live shots -->
      <div class="reveal">
        <div class="poster-frame" id="posterFrame">
          <div class="poster-inner">
            <div class="poster-head">
              <div class="venue" id="posterVenue"></div>
              <div class="series" id="posterSeries"></div>
              <div class="date" id="posterDate"></div>
              <div class="tagline" id="posterTagline"></div>
              <div class="curated" id="posterCurated"></div>
            </div>
            <div class="poster-canvas" id="posterCanvas" aria-label="bouncer nomi"></div>
            <!-- sponsor/adjective poster (testo semplice) -->
            <div class="poster-logos" id="posterLogos" aria-hidden="true"></div>
          </div>
        </div>
        <div class="hero-media" id="liveCarousel" aria-label="live shots"><div class="dots" id="liveDots"></div></div>
        <span class="tag" style="margin-top:12px">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true" style="margin-right:6px">
            <path d="M12 22s7-5.33 7-12a7 7 0 1 0-14 0c0 6.67 7 12 7 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <circle cx="12" cy="10" r="3" stroke="currentColor" stroke-width="2"/>
          </svg>
          Roma • Via di Santa Costanza 17/19
        </span>
      </div>

      <!-- Colonna destra: orari + about -->
      <div class="hero-right">
        <aside class="card reveal" aria-label="Orari e Servizio">
          <div class="block-title"><h3>Orari & Apertura</h3><span class="meta">Servizio</span></div>
          <div class="time-cards">
            <div class="time-card">
              <div class="l">
                <span class="i" aria-hidden="true">
                  <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M17 8h1a4 4 0 0 1 0 8h-1"/><path d="M3 8h14v6a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4Z"/><path d="M6 2v4M10 2v4M14 2v4"/>
                  </svg>
                </span>
                <strong>Colazioni</strong>
              </div>
              <strong>08:00–12:00</strong>
            </div>
            <div class="time-card">
              <div class="l">
                <span class="i" aria-hidden="true">
                  <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M4 3v7a2 2 0 0 0 2 2v9"/><path d="M8 3v7a2 2 0 0 1-2 2"/><path d="M12 3v18"/><path d="M15.5 3.5c2 2 2 6.5 0 8.5L12 12"/>
                  </svg>
                </span>
                <strong>Pranzo</strong>
              </div>
              <strong>12:00–15:00</strong>
            </div>
            <div class="time-card">
              <div class="l">
                <span class="i" aria-hidden="true">
                  <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 7a6 6 0 0 0-6 6h12a6 6 0 0 0-6-6Z"/><path d="M12 5v2"/><path d="M4 19h16"/>
                  </svg>
                </span>
                <strong>Cena</strong>
              </div>
              <strong>19:00–23:00</strong>
            </div>
            <div class="time-card">
              <div class="l">
                <span class="i" aria-hidden="true">
                  <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="2"/><path d="M14 10h.01"/><path d="M10 14h.01"/>
                  </svg>
                </span>
                <strong>DJ Set/Dopocena</strong>
              </div>
              <strong>21:00-00:00 (fino a 01:00 nel weekend)</strong>
            </div>
          </div>
        </aside>

        <div id="about" class="card reveal">
          <div class="block-title"><h3>Urban Bistrot</h3></div>
          <p style="margin:0">17/19 è un bar con cucina contemporanea: si pranza e si cena, si passa per un caffè, si resta per cocktail, aperitivo e dopocena. Facciamo anche eventi con musica dal vivo — line-up curata dai nostri <strong>resident DJ</strong>. Spazio polifunzionale aperto a tutti.</p>
        </div>
      </div>
    </div>
  </section>

  <!-- Menu -->
  <section id="menu">
    <div class="container">
      <div class="block-title" style="margin-bottom:6px"><h3>Il nostro menù</h3></div>
      <div id="menuAccordions" class="grid" style="gap:12px"></div>
    </div>
  </section>

  <!-- Eventi Privati -->
  <section id="private">
    <div class="container">
      <div class="card reveal">
        <div class="block-title">
          <h3>Eventi Privati</h3>
          <span class="meta">Location esclusiva</span>
        </div>
        <p>17/19 Urban Bistrot è la location perfetta per i tuoi eventi privati. Organizziamo con cura ogni dettaglio per rendere speciale la tua occasione.</p>
        
        <div class="private-events">
          <h4>Che tipo di eventi organizziamo:</h4>
          <div class="private-events-grid">
            <span>🎂 Compleanni e feste private</span>
            <span>🎓 Feste di laurea</span>
            <span>🍽️ Cene di gruppo e aziendali</span>
            <span>🎉 Aperitivi e cocktail party</span>
            <span>🎵 Eventi con DJ set personalizzati</span>
          </div>
          <p style="margin:12px 0 16px;font-size:.95rem;color:var(--muted)">
            Spazio dedicato al piano superiore, servizio alla carta o catering, impianto audio e atmosfera unica nel cuore di Roma.
          </p>
          <a class="pill pill--accent" href="https://wa.me/393298252092?text=Ciao%2017%2F19%20Urban%20Bistrot%2C%20vorrei%20organizzare%20un%20evento%20privato" target="_blank" rel="noopener">
            Richiedi Preventivo
          </a>
        </div>
      </div>
    </div>
  </section>

  <!-- Events -->
  <section id="events">
    <div class="container">
      <div class="block-title" style="margin-bottom:6px"><h3>Prossimi Eventi</h3></div>
      <div class="grid" id="eventsList" style="gap:12px"></div>
      <div class="events-more">
        <button id="eventsMoreBtn" class="pill pill--ghost" type="button">Mostra altri</button>
      </div>
    </div>
  </section>

  <!-- Contact + Map -->
  <section id="contact">
    <div class="container grid grid-2">
      <div class="card reveal">
        <div class="block-title"><h3>Contatti</h3></div>
        <p><strong>Indirizzo</strong><br/>Via di Santa Costanza 17/19 – 00198 Roma</p>
        <p><strong>Prenotazioni</strong><br/>
          WhatsApp: <a class="pill" href="https://wa.me/393298252092" target="_blank" rel="noopener">+39 329 825 2092</a><br/>
          <br/>
          Email: <a class="pill" href="mailto:info@1719bistrot.it">info@1719bistrot.it</a>
        </p>
        <p><strong>Social</strong><br/>
          <a class="pill" href="https://instagram.com/1719_cocktailbar" target="_blank" rel="noopener">Instagram</a>
          <a class="pill" href="https://www.facebook.com/p/1719-Cocktail-Bar-Bistrot-100077668764198/" target="_blank" rel="noopener">Facebook</a>
        </p>
      </div>

      <div class="card reveal">
        <div class="block-title">
          <h3>Dove siamo</h3>
          <a class="pill pill--accent" href="https://maps.app.goo.gl/DH48FCh9wvF6mF8p6" target="_blank" rel="noopener">Apri su Google Maps</a>
        </div>
        <div class="map">
          <iframe title="Mappa 17/19 Urban Bistrot" loading="lazy" referrerpolicy="no-referrer-when-downgrade"
            src="https://www.google.com/maps?q=17%2F19%20Cocktail%20Bar%2C%20Via%20di%20Santa%20Costanza%2017%2F19%2C%20Roma&ll=41.9226278,12.514469&z=17&output=embed"></iframe>
        </div>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer>
    <div class="container"><p>&copy; 2025 17/19 Urban Bistrot Roma</p></div>
  </footer>

  <!-- WhatsApp FAB -->
  <a class="fab" href="https://wa.me/393298252092?text=Ciao%2017%2F19%20Urban%20Bistrot" target="_blank" rel="noopener" aria-label="WhatsApp">
    <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
      <path d="M12 1.5c5.8 0 10.5 4.7 10.5 10.5S17.8 22.5 12 22.5A10.5 10.5 0 0 1 6.99 21.23L3 21l.82-3.89A10.45 10.45 0 0 1 1.5 12C1.5 6.2 6.2 1.5 12 1.5Z" fill="currentColor" opacity=".96"/>
      <path d="M16.63 14.62c-.19-.1-1.13-.6-1.3-.66-.17-.06-.29-.1-.42.1s-.49.66-.6.8c-.11.13-.22.15-.41.06-.19-.1-.81-.3-1.55-.98-.57-.51-.95-1.13-1.06-1.31-.11-.19-.01-.29.09-.39.09-.09.2-.24.29-.36.1-.12.13-.2.19-.33.06-.13.03-.25-.02-.35-.05-.1-.44-1.05-.6-1.45-.16-.39-.33-.33-.45-.34h-.38c-.13 0-.33.05-.5.24-.17.19-.66.65-.66 1.59 0 .94.68 1.85.78 2 .1.13 1.31 2.07 3.2 2.91.45.2.8.32 1.04.41.44.15.85.13 1.17.08.36-.05 1.1-.45 1.25-.89.15-.44.15-.82.11-.91-.05-.08-.16-.13-.41-.25Z" fill="#fff"/>
    </svg>
  </a>

  <script>
    /* ================= CONFIG ================= */
    const SHOW_SPONSORS_IN_CARD = false; // true per mostrare testo sponsor nelle card evento
    const KEY = 'eventreactions1719';    // chiave condivisa col backend
    const PERSIST_REMOTE = {
      enabled: true,
      endpoint: 'https://script.google.com/macros/s/AKfycbyukoQfi8AKrj0dtGGU4gRCCjWMA8Aik1E1s1ssTmWazIEGk0yJjdavqsWd4LE0_Z4/exec?key=eventreactions1719'
    };
    
    // CONFIG: Poster vs Live Shots
    const SHOW_POSTER = false; // false = mostra live shots, true = mostra poster

    /* ================= TUNABLES (fisica) ================= */
    const PHYS = {
      base: 42, rand: 18,
      damping: 0.996,
      restitution: 0.92,
      wallRestitution: 0.90,
      min: 18, max: 160,
      measureEvery: 12,
      pad: -6,        // maggiore sovrapposizione visiva
      sepBias: 1.2,   // non più usato nella nuova risoluzione, lasciato per compatibilità 
      nudge: 8,
      boostMax: 4.5,
      burstMs: 900,
      randomResolveMod: 4
    };

    /* ================= Utils & SVGs ================= */
    const $ = (s, r=document)=>r.querySelector(s);
    const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));
    const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
    const slug = s=>String(s||'').toLowerCase().replace(/\s+/g,'-').replace(/[^a-z0-9\-]/g,'');
    const UUID = ()=>crypto.randomUUID ? crypto.randomUUID() : Math.random().toString(36).slice(2)+'-'+Date.now();
    const deviceId = (()=>{ const k='1719-device'; let d=localStorage.getItem(k); if(!d){ d=UUID(); localStorage.setItem(k,d); } return d; })();

    const SVG = {
      up: `<svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M12 3l7 7h-4v11H9V10H5l7-7z" fill="currentColor"/></svg>`,
      help: `<svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 1 1 5.83 1c0 2-3 2-3 4"/><path d="M12 17h.01"/></svg>`,
      share: `<svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M18 8a3 3 0 1 0-2.83-4h0A3 3 0 0 0 18 8ZM6 14a3 3 0 1 0-2.83 4h0A3 3 0 0 0 6 14ZM18 16a3 3 0 1 0 2.83 4h0A3 3 0 0 0 18 16Z" fill="currentColor"/><path d="M8.59 13.51l6.82-3.02M8.59 16.49l6.82 3.02" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/></svg>`
    };

    /* ================= Scroll reveal ================= */
    const reveals = document.querySelectorAll('.reveal');
    const io = new IntersectionObserver((entries)=>{
      entries.forEach(e => { if(e.isIntersecting){ e.target.classList.add('active'); io.unobserve(e.target);} });
    },{ threshold:.14 });
    reveals.forEach(el=>io.observe(el));

    /* ================= Header translucido ================= */
    const header = document.querySelector('header');
    const onS = () => { header.classList.toggle('header--solid', window.scrollY > 8); };
    window.addEventListener('scroll', onS, {passive:true}); onS();

    /* ================= Fullscreen menu ================= */
    const siteMenu = document.getElementById('siteMenu');
    const sheetClose = document.getElementById('sheetClose');
    const panel = siteMenu.querySelector('.sheet__panel');
    const inner = siteMenu.querySelector('.sheet__inner');
    const toggleBtns = [document.getElementById('menuToggle'), document.getElementById('menuToggleD')].filter(Boolean);
    const openMenu = ()=>{ siteMenu.classList.add('active'); siteMenu.setAttribute('aria-hidden','false'); document.body.classList.add('menu-open'); };
    const closeMenu = ()=>{ siteMenu.classList.remove('active'); siteMenu.setAttribute('aria-hidden','true'); document.body.classList.remove('menu-open'); };
    toggleBtns.forEach(btn=> btn.addEventListener('click', ()=> siteMenu.classList.contains('active') ? closeMenu() : openMenu()));
    sheetClose.addEventListener('click', (e)=>{ e.stopPropagation(); closeMenu(); });
    panel.addEventListener('click', (e)=>{ if(!inner.contains(e.target)) closeMenu(); });
    inner.addEventListener('click', (e)=> e.stopPropagation());
    window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeMenu(); });
    siteMenu.querySelectorAll('a').forEach(a=> a.addEventListener('click', ()=> setTimeout(closeMenu,80)));

    /* ================= Link esterni fix ================= */
    (function(){
      document.querySelectorAll('a[href^="http"]').forEach(a=>{
        try{ const u=new URL(a.getAttribute('href'), location.href); if(u.origin!==location.origin){ a.setAttribute('target','_blank'); a.setAttribute('rel','noopener'); } }catch{}
      });
      document.addEventListener('click', function(e){
        const a = e.target.closest('a[href]'); if(!a) return;
        const href = a.getAttribute('href'); if(!href) return;
        if(href.startsWith('#') || href.startsWith('mailto:') || href.startsWith('tel:') || href.startsWith('javascript:')) return;
        let isExternal=false; try{ isExternal = (new URL(href, location.href).origin !== location.origin); }catch{}
        const openNewTab = isExternal || a.getAttribute('target')==='_blank';
        if(openNewTab){ e.preventDefault(); e.stopImmediatePropagation(); const win = window.open(href, '_blank'); if(!win){ location.href = href; } }
      }, true);
    })();

    /* ================= Theme + Tips buttons ================= */
    const THEME_KEY = 'theme-1719';
    const root = document.documentElement;
    function applyTheme(mode){ root.setAttribute('data-theme', mode); localStorage.setItem(THEME_KEY, mode); paintThemeIcon(mode); paintTipsIcon(); }
    function paintThemeIcon(mode){
      const svgAuto = `<svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true"><circle cx="12" cy="12" r="5" fill="currentColor" opacity=".9"/><text x="12" y="22" text-anchor="middle" font-size="7" font-family="monospace" fill="currentColor" opacity=".9">AUTO</text></svg>`;
      const svgSun  = `<svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="4"></circle><path d="M12 2v2m0 16v2M2 12h2m16 0h2M4.9 4.9l1.4 1.4M17.7 17.7l1.4 1.4M4.9 19.1l1.4-1.4M17.7 6.3l1.4-1.4"/></svg>`;
      const svgMoon = `<svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>`;
      const icon = mode==='auto' ? svgAuto : mode==='light' ? svgSun : svgMoon;
      document.querySelectorAll('#themeToggle,#themeToggleM').forEach(btn=>btn.innerHTML = icon);
    }
    function paintTipsIcon(){ const icon = `<div style="display:grid;place-items:center">${SVG.up}</div>`; document.querySelectorAll('#tipsBtn,#tipsBtnM').forEach(btn=>btn.innerHTML = icon); }
    function cycleTheme(){ const cur = root.getAttribute('data-theme') || 'auto'; const next = cur==='auto' ? 'light' : cur==='light' ? 'dark' : 'auto'; applyTheme(next); }
    document.getElementById('themeToggle')?.addEventListener('click', cycleTheme);
    document.getElementById('themeToggleM')?.addEventListener('click', cycleTheme);
    applyTheme(localStorage.getItem(THEME_KEY) || 'auto');

    // Toast: stile card, con auto-hide a 10s (riarmato a ogni apertura)
    const toast = document.getElementById('tipsToast');
    let toastTimer = null;
    function openToast(){
      toast.classList.add('show');
      clearTimeout(toastTimer);
      toastTimer = setTimeout(()=> toast.classList.remove('show'), 10000);
    }
    function closeToast(){
      toast.classList.remove('show');
      clearTimeout(toastTimer);
    }
    function toggleToast(){
      if(toast.classList.contains('show')) closeToast();
      else openToast();
    }
    document.getElementById('tipsBtn')?.addEventListener('click', toggleToast);
    document.getElementById('tipsBtnM')?.addEventListener('click', toggleToast);
    toast.querySelector('.x').addEventListener('click', closeToast);

    /* ================= Live Shots ================= */
    
    
    const liveImages = [
      '/media/carosello1.webp',
      '/media/carosello2.webp',
      '/media/carosello3.webp',
      '/media/carosello4.webp',
    ];
    


    
function setupLiveCarousel(){
  const box  = document.getElementById('liveCarousel');
  const dots = document.getElementById('liveDots');
  if(!box) return;

  // ensure container classes
  box.classList.add('live-box');

  // Clear any existing content
  box.innerHTML = '';
  if(dots) dots.innerHTML = '';

  // local loader
  const overlay = document.createElement('div');
  overlay.className = 'loader-overlay';
  overlay.innerHTML = '<span class="loader--ring" aria-hidden="true"></span>';
  box.appendChild(overlay);

  let i = 0; const slides=[], bullets=[];
  liveImages.forEach((src,idx)=>{
    const s = document.createElement('div'); s.className='slide'+(idx===0?' active':'');
    const im=new Image();
    im.alt='Live '+(idx+1);
    im.decoding='async';
    im.loading = idx < 2 ? 'eager' : 'lazy';
    im.fetchPriority = idx < 2 ? 'high' : 'low';
    im.style.width='100%'; im.style.height='100%'; im.style.objectFit='cover';
    im.addEventListener('load', ()=>{ if(idx===0){ overlay.classList.add('hidden'); } });
    im.src=src;
    s.appendChild(im);
    box.appendChild(s); slides.push(s);

    const b=document.createElement('button'); b.className='dot'+(idx===0?' active':''); b.addEventListener('click',()=>go(idx)); if(dots) dots.appendChild(b); bullets.push(b);
  });
  if(dots) box.appendChild(dots);

  function go(n){
    if(n===i || n<0 || n>=slides.length) return;
    const cur=slides[i], nxt=slides[n];
    // Preload next image if not complete
    const img = nxt.querySelector('img');
    if(img && !img.complete){ overlay.classList.remove('hidden'); img.addEventListener('load', ()=>overlay.classList.add('hidden'), {once:true}); }

    // double-rAF to ensure class transition
    requestAnimationFrame(()=>{
      cur.classList.remove('active');
      nxt.classList.add('active');
      if(bullets[i]) bullets[i].classList.remove('active');
      if(bullets[n]) bullets[n].classList.add('active');
      i=n;
    });
  }

  // Touch / swipe handlers
  let startX=0, startY=0, deltaX=0, deltaY=0, isTouching=false;
  const THRESH = 40; // px to trigger swipe

  function onTouchStart(e){
    const t = e.touches ? e.touches[0] : e;
    startX = t.clientX; startY = t.clientY; deltaX = 0; deltaY = 0; isTouching = true;
  }
  function onTouchMove(e){
    if(!isTouching) return;
    const t = e.touches ? e.touches[0] : e;
    deltaX = t.clientX - startX;
    deltaY = t.clientY - startY;
  }
  function onTouchEnd(){
    if(!isTouching) return;
    isTouching = false;
    if(Math.abs(deltaX) > Math.max(THRESH, Math.abs(deltaY))){
      if(deltaX < 0){ go((i+1)%slides.length); } else { go((i-1+slides.length)%slides.length); }
    }
  }
  box.addEventListener('touchstart', onTouchStart, {passive:true});
  box.addEventListener('touchmove', onTouchMove, {passive:true});
  box.addEventListener('touchend', onTouchEnd, {passive:true});

  // Expose programmatic controls if needed
  box.dataset.carouselReady = "1";
}/* ================== STORE (local + GAS JSONP/Beacon) ================== */
    const Store = {
      key:'1719-reactions-v6',
      state:{
        aggRocketsByName:{},   // aggregato server → NOMI
        myFlamesByEvent:{},    // toggle locale utente → EVENTI (0/1)
        aggFlamesByEvent:{},   // aggregato server → EVENTI
        totals:{rockets:0, flames:0, devices:0}
      },
      logQueue:[],

      load(){
        try{ const s=localStorage.getItem(this.key); if(s){ this.state={...this.state, ...JSON.parse(s)} } }catch{}
      },
      saveLocal(){
        try{ localStorage.setItem(this.key, JSON.stringify(this.state)); }catch{}
      },

      // Getters
      getRocketsAgg(name){ return this.state.aggRocketsByName[String(name||'').toUpperCase()]||0; },
      getFlameCount(eid){ return this.state.aggFlamesByEvent[eid]||0; },
      getMyFlame(eid){ return this.state.myFlamesByEvent[eid]||0; },
      totals(){ return this.state.totals || {rockets:0, flames:0, devices:0}; },

      // Actions
      incRocket({name, ctx}){
        if(!name) return 0;
        const NAME = String(name).toUpperCase();
        this.enqueueLog({type:'name_upvote', name:NAME, ctx});
        // Ottimismo UI
        this.state.aggRocketsByName[NAME] = (this.state.aggRocketsByName[NAME]||0)+1;
        this.state.totals.rockets = Object.values(this.state.aggRocketsByName).reduce((a,b)=>a+b,0);
        this.saveLocal(); this.remotePushDebounced();
        return this.getRocketsAgg(NAME);
      },

      toggleFlame({eid, on, ctx}){
        const cur  = this.getMyFlame(eid);
        const next = (on!=null) ? (on?1:0) : (cur?0:1);
        this.state.myFlamesByEvent[eid] = next;

        // Ottimismo UI sul conteggio aggregato
        const agg = this.getFlameCount(eid);
        const newAgg = clamp(agg + (next - cur), 0, 1e9);
        this.state.aggFlamesByEvent[eid] = newAgg;
        this.state.totals.flames = Object.values(this.state.aggFlamesByEvent).reduce((a,b)=>a+b,0);

        this.enqueueLog({type:'event_vote', eid, on:next, ctx});
        this.saveLocal(); this.remotePushDebounced();
        return next;
      },

      enqueueLog(entry){
        const when = new Date().toISOString();
        const ua   = navigator.userAgent||'';
        const page = location.href;
        this.logQueue.push({...entry, when, deviceId, ua, page});
        if(this.logQueue.length>50) this.remotePush();
      },

      // Pull aggregati (JSONP)
      remotePull(){
        if(!PERSIST_REMOTE.enabled || !PERSIST_REMOTE.endpoint) return Promise.resolve();
        return new Promise((resolve)=>{
          const cb = 'CB_'+Math.random().toString(36).slice(2);
          window[cb] = (B)=>{
            try{
              if(B && typeof B==='object'){
                this.state.aggRocketsByName = B.rocketsByName || {};
                this.state.aggFlamesByEvent = B.flamesByEvent || {};
                this.state.totals = B.totals || this.state.totals;
                this.saveLocal();
                if(typeof updateEventCountsFromStore==='function') updateEventCountsFromStore();
                if(typeof updatePosterChipCounts==='function') updatePosterChipCounts();
              }
            } finally {
              delete window[cb]; s.remove(); resolve();
            }
          };
          const s = document.createElement('script');
          s.src = PERSIST_REMOTE.endpoint + '&callback=' + cb;
          s.onerror = ()=>{ delete window[cb]; s.remove(); resolve(); };
          document.head.appendChild(s);
        });
      },

      // Push solo LOGS (con key nel body)
      async remotePush(){
        if(!PERSIST_REMOTE.enabled || !PERSIST_REMOTE.endpoint) return;
        try{
          const logs = this.logQueue.splice(0);
          if(!logs.length) return;
          const body = JSON.stringify({ key:KEY, logs });
          const blob = new Blob([body], {type:'text/plain;charset=utf-8'});
          if (navigator.sendBeacon) navigator.sendBeacon(PERSIST_REMOTE.endpoint, blob);
          else await fetch(PERSIST_REMOTE.endpoint, { method:'POST', mode:'no-cors', body: blob });
          // Pull di allineamento poco dopo
          setTimeout(()=>this.remotePull(), 600);
        }catch(_){}
      },
      remotePushDebounced:(()=>{ let t; return function(){ clearTimeout(t); t=setTimeout(()=>this.remotePush(), 400); }; })()
    };

    Store.load();
    Store.remotePull();
    setInterval(()=>Store.remotePull(), 20000); // aggiornamento "live-ish"

    /* ================= Double-tap handler ================= */
    function makeDoubleTap(el, handler, threshold=300, moveTol=18){
      let lastTime=0, lastX=0, lastY=0;
      el.addEventListener('pointerdown', (e)=>{
        if(e.pointerType!=='mouse') e.preventDefault();
        e.stopPropagation();
        const now = performance.now(); const x=e.clientX, y=e.clientY;
        const dt = now - lastTime; const dist = Math.hypot(x-lastX, y-lastY);
        if(dt < threshold && dist < moveTol){ lastTime=0; handler(e); } else { lastTime=now; lastX=x; lastY=y; }
      }, {passive:false});
      el.addEventListener('dblclick', (e)=>{ e.preventDefault(); e.stopPropagation(); }, {passive:false});
    }

    /* ================= Poster / Bouncers ================= */
    const posterData = {
      venue: '17/19 URBAN BISTROT',
      series: 'ELECTRO TECHNO NIGHT',
      date:   'WEDNESDAY 03/09',
      tagline:'TECHNO • ELECTRO • VINYL',
      curatedBy:'CURATED BY RESIDENT DJS',
      logos:[ { text:'CASAMIGOS' }, { text:'ORGANICS' }, { text:'UPVOTES' } ]
    };
    let currentPosterEventCtx = null; // {eid, title, dateISO}

    const posterCanvas = document.getElementById('posterCanvas');
    let bounceRAF = null, bouncers = [];
    let trailCanvas=null, trailCtx=null, trailRO=null;

    // collision burst / random throttling (manteniamo variabili per compatibilità)
    let collisionBurstUntil = 0;
    let frameCounter = 0;

    function setPosterTexts(p){
      const set = (id,txt)=>{ const el=document.getElementById(id); if(el) el.textContent=(txt||'').toUpperCase(); };
      set('posterVenue', p.venue); set('posterSeries',p.series); set('posterDate', p.date); set('posterTagline', p.tagline); set('posterCurated', p.curatedBy);
      const logosWrap = document.getElementById('posterLogos'); if(logosWrap){ logosWrap.innerHTML='';
      (p.logos||[]).forEach(L=>{ const span=document.createElement('span'); span.className='poster-sponsor'; span.textContent=(L.text||'').toUpperCase(); logosWrap.appendChild(span); }); }
    }
    function setupTrailCanvas(){
      if(trailCanvas) return;
      trailCanvas = document.createElement('canvas');
      trailCanvas.className = 'trail';
      posterCanvas.appendChild(trailCanvas);
      trailCtx = trailCanvas.getContext('2d');
      const resize = ()=> { const w = posterCanvas.clientWidth|0, h = posterCanvas.clientHeight|0; trailCanvas.width = w; trailCanvas.height = h; trailCtx.clearRect(0,0,w,h); };
      resize();
      if('ResizeObserver' in window){ trailRO = new ResizeObserver(resize); trailRO.observe(posterCanvas); }
      else window.addEventListener('resize', resize);
    }
    function easeInOutCubic(t){ return t<.5 ? 4*t*t*t : 1 - Math.pow(-2*t+2,3)/2; }

    function sparkle(x,y){
      if(!trailCtx) return;
      const parts = 10;
      for(let i=0;i<parts;i++){
        (function(i){
          const a = Math.random()*Math.PI*2, v= 40+Math.random()*80, life=250+Math.random()*350;
          const start = performance.now();
          function tick(now){
            const t = Math.min(1,(now-start)/life);
            const px = x + Math.cos(a)*v*t, py = y + Math.sin(a)*v*t;
            trailCtx.save(); trailCtx.globalCompositeOperation='lighter'; trailCtx.fillStyle=`rgba(255,31,61,${1-t})`;
            trailCtx.beginPath(); trailCtx.arc(px,py,2*(1-t),0,Math.PI*2); trailCtx.fill(); trailCtx.restore();
            if(t<1) requestAnimationFrame(tick);
          }
          requestAnimationFrame(tick);
        })(i);
      }
    }

    function clearBouncers(){
      cancelAnimationFrame(bounceRAF);
      bouncers.forEach(b=> b.el.remove());
      bouncers = [];
      if(trailCtx){ trailCtx.clearRect(0,0,trailCanvas.width,trailCanvas.height); }
    }

    function triggerUpvote(targetEl){
      const b = bouncers.find(x=>x.el===targetEl); if(!b) return;
      const name = targetEl.dataset.name || '';
      const now = performance.now();
      const DUR = 1100, BOOST = PHYS.boostMax;
      b.boost = {start:now, end:now+DUR, max:BOOST};
      targetEl.classList.add('up-lit');

      // counter + log (ottimismo UI)
      const n = Store.incRocket({name, ctx: currentPosterEventCtx});
      const cnt = targetEl.querySelector('.rc .n'); if(cnt) cnt.textContent = n;

      // leggero scale
      targetEl.style.transform += ' scale(1.06)'; setTimeout(()=> targetEl.style.transform = targetEl.style.transform.replace(' scale(1.06)',''), 140);

      // scintille
      const cx = b.x + b.w/2, cy = b.y + b.h/2;
      sparkle(cx, cy);
      b.trailPulseUntil = now + DUR;

      // "burst" collisioni (manteniamo per spinta generale)
      collisionBurstUntil = performance.now() + PHYS.burstMs;

      // ricalcola dimensioni in caso di numero che cresce
      const r = targetEl.getBoundingClientRect(); b.w = r.width; b.h = r.height; b.r = Math.max(14, 0.25*(b.w+b.h));
    }

    function limitVel(b){
      const s = Math.hypot(b.vx, b.vy) || 0.0001;
      if (s < PHYS.min){ const f = PHYS.min / s; b.vx *= f; b.vy *= f; }
      if (s > PHYS.max){ const f = PHYS.max / s; b.vx *= f; b.vy *= f; }
    }

    function initBouncers(names){
      clearBouncers(); setupTrailCanvas();
      const rect = posterCanvas.getBoundingClientRect();
      names.forEach((name, idx)=>{
        const el = document.createElement('div');
        el.className = 'bouncer';
        el.dataset.name = name.toUpperCase();
        el.innerHTML = `<span class="dot"></span><span class="lbl">${name}</span><span class="rc">${SVG.up}<span class="n">${Store.getRocketsAgg(name)}</span></span>`;
        posterCanvas.appendChild(el);

        const w = el.offsetWidth || 80, h = el.offsetHeight || 28;
        const r = Math.max(14, 0.25*(w+h)); // raggio per collisioni "circolari"

        // spawn non sovrapposto (max 20 tentativi)
        let x = 0, y = 0;
        for (let tries=0; tries<20; tries++){
          x = Math.random() * Math.max(1, rect.width  - w);
          y = Math.random() * Math.max(1, rect.height - h);
          const overlap = bouncers.some(o => {
            const ax=x+w/2, ay=y+h/2, bx=o.x+o.w/2, by=o.y+o.h/2;
            const d = Math.hypot(bx-ax, by-ay);
            return d < (r + o.r + 2);
          });
          if (!overlap) break;
        }

        const speed = PHYS.base + Math.random()*PHYS.rand;
        const angle = Math.random() * Math.PI * 2;
        const vx = Math.cos(angle) * speed;
        const vy = Math.sin(angle) * speed;

        bouncers.push({ el, x, y, w, h, r, vx, vy, boost:null, trailPulseUntil:0 });
        makeDoubleTap(el, ()=>triggerUpvote(el));
      });

      let last = performance.now();
      frameCounter = 0;

      const tick = (now)=>{
        const dt = (now - last) / 1000; last = now;
        const W = posterCanvas.clientWidth, H = posterCanvas.clientHeight;

        // fade-out trail
        if(trailCtx && (trailCanvas.width!==W || trailCanvas.height!==H)){ trailCanvas.width=W; trailCanvas.height=H; }
        if(trailCtx){
          trailCtx.save(); trailCtx.globalCompositeOperation = 'destination-out';
          trailCtx.fillStyle = 'rgba(0,0,0,0.08)'; trailCtx.fillRect(0,0,W,H); trailCtx.restore();
        }

        // update
        bouncers.forEach(b=>{
          // damping
          b.vx *= PHYS.damping; b.vy *= PHYS.damping;

          // boost
          if(b.boost && now < b.boost.end){
            const t = (now - b.boost.start) / (b.boost.end - b.boost.start);
            const e = easeInOutCubic(clamp(t,0,1));
            const factor = 1 + e*(b.boost.max - 1);
            b.vx *= factor; b.vy *= factor;

            // trail pulse
            if(trailCtx){
              const cx = b.x + b.w/2, cy = b.y + b.h/2;
              const len = 10 + 30*e;
              const norm = Math.hypot(b.vx,b.vy) || 1;
              const bx = cx - (b.vx/norm) * len;
              const by = cy - (b.vy/norm) * len;
              trailCtx.save();
              trailCtx.globalCompositeOperation='lighter';
              trailCtx.lineWidth = 1 + 2*e;
              trailCtx.strokeStyle = `rgba(255,31,61,${0.45+0.25*e})`;
              trailCtx.beginPath(); trailCtx.moveTo(bx,by); trailCtx.lineTo(cx,cy); trailCtx.stroke();
              trailCtx.restore();
            }
          } else if (b.boost && now >= b.boost.end){
            b.boost = null;
            b.el.classList.remove('up-lit');
          }

          // integrazione
          let nx = b.x + b.vx * dt;
          let ny = b.y + b.vy * dt;

          // pareti
          if (nx <= 0){ nx = 0; b.vx = Math.abs(b.vx) * PHYS.wallRestitution; }
          if (ny <= 0){ ny = 0; b.vy = Math.abs(b.vy) * PHYS.wallRestitution; }
          if (nx + b.w >= W){ nx = W - b.w; b.vx = -Math.abs(b.vx) * PHYS.wallRestitution; }
          if (ny + b.h >= H){ ny = H - b.h; b.vy = -Math.abs(b.vy) * PHYS.wallRestitution; }

          limitVel(b);

          // applica
          b.x = nx; b.y = ny;
          b.el.style.transform = `translate(${nx}px, ${ny}px)`;
        });

        // ricalcolo dimensioni periodico
        if ((frameCounter % PHYS.measureEvery) === 0){
          bouncers.forEach(b=>{
            const br = b.el.getBoundingClientRect();
            b.w = br.width; b.h = br.height;
            b.r = Math.max(14, 0.25*(b.w+b.h));
          });
        }

        // Collisioni: sempre (pochi elementi → fluido e naturale)
        resolveCollisions();

        frameCounter++;
        bounceRAF = requestAnimationFrame(tick);
      };
      bounceRAF = requestAnimationFrame(tick);
    }

    // Collisioni "morbide" come cerchi
    function resolveCollisions(){
      const e = PHYS.restitution;
      for(let i=0;i<bouncers.length;i++){
        for(let j=i+1;j<bouncers.length;j++){
          const a=bouncers[i], b=bouncers[j];

          // Centri
          const ax=a.x + a.w/2, ay=a.y + a.h/2;
          const bx=b.x + b.w/2, by=b.y + b.h/2;

          const dx=bx-ax, dy=by-ay;
          const dist2 = dx*dx + dy*dy;
          const minD = (a.r + b.r) + PHYS.pad; // pad < 0 = più sovrapposizione visiva
          if(dist2 < minD*minD){
            const dist = Math.max(Math.sqrt(dist2), 1e-6);
            let nx = dx/dist, ny = dy/dist;      // normale

            // Correzione posizionale parziale (morbida)
            const penetration = minD - dist;
            const percent = 0.20; // più basso = più smooth
            const corr = Math.max(penetration, 0) * percent;
            a.x -= nx * corr; a.y -= ny * corr;
            b.x += nx * corr; b.y += ny * corr;

            // Impulso elastico solo se si avvicinano
            const rvx = b.vx - a.vx;
            const rvy = b.vy - a.vy;
            const velAlongNormal = rvx*nx + rvy*ny;

            if(velAlongNormal < 0){
              const jimp = -(1+e)*velAlongNormal / 2; // masse=1
              // Kick tangenziale leggero anti-sticking
              const tx = -ny, ty = nx;
              const kick = (Math.random()-0.5)*PHYS.nudge*0.5;

              a.vx -= jimp*nx - tx*kick; a.vy -= jimp*ny - ty*kick;
              b.vx += jimp*nx + tx*kick; b.vy += jimp*ny + ty*kick;

              limitVel(a); limitVel(b);
            }
          }
        }
      }
    }

    function formatPosterDate(iso){
      const d = new Date(iso + 'T12:00:00Z');
      const days = ['SUNDAY','MONDAY','TUESDAY','WEDNESDAY','THURSDAY','FRIDAY','SATURDAY'];
      const dd = String(d.getUTCDate()).padStart(2,'0'); const mm = String(d.getUTCMonth()+1).padStart(2,'0');
      return `${days[d.getUTCDay()]} ${dd}/${mm}`;
    }
    function toItDowShort(d){ return d.toLocaleString('it-IT',{weekday:'short'}).toUpperCase(); }
    function toMonShort(d){ return d.toLocaleString('it-IT',{month:'short'}).toUpperCase(); }
    function formatLongIt(iso){
      const d = new Date(iso + 'T12:00:00');
      return d.toLocaleDateString('it-IT', { weekday:'short', day:'numeric', month:'long', year:'numeric' });
    }

    function buildShareText(ev){
      const when = formatLongIt(ev.dateISO);
      const start = ev.start ? ` (start ${ev.start})` : '';
      const artists = [ev.headliner, ...(ev.guests||[])].filter(Boolean).join(', ');
      let lines = [];
      lines.push(`🎶 ${ev.title}`);
      if(artists) lines.push(`👤 ${artists}`);
      if(ev.genres?.length) lines.push(`🎧 ${ev.genres.join(' • ')}`);
      lines.push(`📍 17/19 Urban Bistrot • Roma`);
      lines.push(`🗓️ ${when}${start}`);
      lines.push('');
      lines.push(`Ti va?`);
      return lines.join('\n');
    }
    function waUrlFromEvent(ev){ return `https://wa.me/?text=${encodeURIComponent(buildShareText(ev))}`; }
    function tgUrlFromEvent(ev){ return `https://t.me/share/url?text=${encodeURIComponent(buildShareText(ev))}`; }
    function xUrlFromEvent(ev){ return `https://twitter.com/intent/tweet?text=${encodeURIComponent(buildShareText(ev))}`; }

    /* ===== MENU DATA ===== */
    // Menu con sezioni espandibili
    const menuData = [
      { 
        badge:'BREAKFAST', 
        title:'Colazione',
        isMainCategory: true,
        groups:[
          { title:'Colazioni Special', collapsed: true, items:[
            { name:"Colazione all'Italiana", desc:"Tris di mieli italiani selezionati e frutta fresca; latticino con pan dolce/integrale e frutta secca; latte aromatizzato e caffè", price:"€10,00" },
            { name:"French Breakfast", desc:"Tè o infuso d'erbe; pan piastrato o pan brioche con burro; selezione di marmellate/composte/confetture", price:"€7,00" },
            { name:"Danish Breakfast", desc:"Spremuta; toast o pancake con sciroppo d'acero; caffè", price:"€7,00" },
            { name:"American Breakfast Salata", desc:"Bacon e uova strapazzate; pan piastrato, burro e confetture/composte; caffè americano", price:"€12,00" },
            { name:"American Breakfast Dolce", desc:"Cioccolata calda con panna; mini muffin assortiti o pasticceria da tè; caffè americano", price:"€10,00" },
            { name:"American Breakfast Piccante", desc:"Uova strapazzate alla paprika; pan piastrato e salame piccante; caffè americano", price:"€12,00" }
          ]},
          { title:'Bakery', collapsed: true, items:[
            { name:"Pancake con sciroppo d'acero o d'agave", price:"€4,00" },
            { name:"Pancake con crema, cioccolata o crema di pistacchio e panna", price:"€5,00" },
            { name:"Pancake con confettura o marmellata e frutta fresca", price:"€5,00" },
            { name:"Pasticceria da tè (al pz.)", price:"€1,50" },
            { name:"Crostata di marmellata (al pz.)", price:"€3,50" },
            { name:"Croissant mignon semplice o farcito", price:"€1,50" },
            { name:"Mini muffin classico o farcito", price:"€1,50" },
            { name:"Mini bombetta o mini ciambellina", price:"€1,50" }
          ]},
          { title:'Cioccolata calda', collapsed: true, items:[
            { name:"Classica oro", price:"€4,50" },
            { name:"Caramello salato", price:"€4,50" },
            { name:"Gianduia", price:"€4,50" },
            { name:"Rose e lamponi", price:"€4,50" },
            { name:"Arancia e cannella", price:"€4,50" },
            { name:"Fondente o bianca al pistacchio", price:"€4,50" },
            { name:"Menta", price:"€4,50" }
          ]},
          { title:'Caffetteria', collapsed: true, items:[
            { name:"Espresso", price:"€1,50" },
            { name:"Espresso decaffeinato", price:"€2,00" },
            { name:"Espresso americano", price:"€2,50" },
            { name:"Latte macchiato", price:"€2,50" },
            { name:"Caffè latte", price:"€3,00" },
            { name:"Caffè o cappuccino spécial", price:"€4,00" },
            { name:"Cappuccino", price:"€2,00" },
            { name:"Cappuccino vegetale di soya", price:"€3,00" },
            { name:"Cappuccino senza lattosio", price:"€3,00" },
            { name:"Orzo (piccolo / grande)", price:"€2,00 / €2,50" },
            { name:"Ginseng (piccolo / grande)", price:"€2,00 / €2,50" },
            { name:"Tè, rooibos o infuso d'erbe", price:"€4,00" }
          ]},
          { title:'Succhi & Frutta', collapsed: true, items:[
            { name:"Spremuta di agrumi", price:"€4,00" },
            { name:"Centrifugato", price:"€5,00" },
            { name:"Macedonia o tagliata di frutta fresca", price:"€6,00" },
            { name:"Granita", price:"€6,00" },
            { name:"Milkshake", price:"€4,00" }
          ]}
        ]
      },
    { 
  badge:'GASTRONOMY', 
  title:'Gastronomia', 
  isMainCategory: true,
  groups:[
    { title:'Club Sandwiches', collapsed: true, items:[
         { "name": "ClubSandwich + Patate", "desc": "Scegli uno dei gusti che più preferisci, e affianco troverai una produzione di chips di nostra produzione con salse incluse", "price": "€12,00", "photo":"/media/Clubsandwichpatate.webp" },
      { "name": "Classic Club", "desc": "Prosciutto e formaggio, insalata con pomodoro e pancetta", "price": "€8,00", "photo":"/media/Club%20Sandwich%20Cotto.webp" },
      { "name": "Tonno Club", "desc": "Insalata di tonno con radicchio, uovo sodo, salsa tartara, insalata e pomodoro", "price": "€8,00", "photo":"/media/Club%20Sandwich%20tonno.webp" },
      { "name": "Salmone Club", "desc": "Salmone affumicato, Philadelphia, uovo sodo, insalata e pomodoro", "price": "€9,00", "photo":"/media/Club%20Sandwich%20salmone.webp" },
      { "name": "Hummus Club", "desc": "Hummus di nostra produzione, Melanzane, Zucchine", "price": "€9,00", "photo":"/media/Club%20Sandwich%20hummus.webp" },
      { "name": "Pollo Club", "desc": "Insalata di pollo, salsa bernese, insalata di pomodoro, peperoni grigliati", "price": "€9,00", "photo":"/media/Club%20Sandwich%20Pollo.webp"}
    ]},
    { title:'Taglieri & Focacce', collapsed: true, items:[
      { "name": "Gran Tagliere", "desc": "Selezione di affettati e formaggi", "price": "€25" },
      { "name": "Tagliere Misto", "desc": "Selezione di affettati", "price": "€15" },
      { "name": "Tagliere Nostrano", "desc": "Prosciutto crudo stagionato e bufala", "price": "€12" },
      { "name": "Focaccia Bianca", "desc": "Con olio e rosmarino", "price": "€5" }
    ]},
    { title:'Primi Piatti', collapsed: true, items:[
      { "name": "Lasagna alla Bolognese", "price": "€10" },
      { "name": "Lasagna Vegetariana", "price": "€10" },
      { "name": "Parmigiana di Melanzane", "price": "€10" },
      { "name": "Ravioloni al sentore di Pistacchio con Ragù Bianco", "price": "€13" },
      { "name": "Ravioli Cacio e Pepe", "price": "€13" },
      { "name": "Ravioli Pomodoro e Basilico", "price": "€13" }
    ]},
    { title:'Secondi Piatti', collapsed: true, items:[
      { "name": "Pollo al Curry", "price": "€9" },
      { "name": "Tagliata di Pollo alle Erbe", "price": "€9" },
      { "name": "Guancia di Manzo al Vino Rosso", "price": "€14" },
      { "name": "Spezzatino alla Cacciatora", "price": "€14" },
      { "name": "Bocconcini alle Prugne", "price": "€14" },
      { "name": "Polpette al Vino Bianco", "price": "€10" },
      { "name": "Polpette al Sugo", "price": "€10" },
      { "name": "Polpette Cacio e Pepe", "price": "€10" }
    ]},
    { title:'Contorni', collapsed: true, items:[
      { "name": "Cicoria Ripassata", "price": "€7" },
      { "name": "Scarola alla Partenopea", "price": "€7" },
      { "name": "Broccoli Siciliani Ripassati", "price": "€7" },
      { "name": "Patate al Forno", "price": "€6" },
      { "name": "Verdure Grigliate", "price": "€6" }
    ]},
    { title:'Piatto Unico', collapsed: true, items:[
      { "name": "Piatto Unico", "price": "€12" },
    ]},
    { title:'Tartare', collapsed: true, items:[
      { "name": "Piemontese", "desc": "Carne di Fassona", "price": "€14" },
      { "name": "Esotica", "desc": "Tonno", "price": "€14" },
      { "name": "17/19", "desc": "Salmone", "price": "€14" }
    ]},
    { title:'Insalate', collapsed: true, items:[
      { "name": "Nordica", "desc": "Salmone, avocado, mozzarella", "price": "€10" },
      { "name": "Mista", "desc": "Pomodoro, carote, cetriolo, finocchio", "price": "€9" },
      { "name": "Caesar", "desc": "Pollo, salsa Caesar, crostini e grana", "price": "€10" }
    ]}
  ]
},

      { 
        badge:'DRINKS', 
        title:'Drinks', 
        isMainCategory: true,
        items:[
          { name:'— In allestimento —', desc:'', price:'' , photo: null}
        ]
      }
    ];

    function renderMenu(){
      const wrap = document.getElementById('menuAccordions');
      wrap.innerHTML = '';
      
      menuData.forEach(cat=>{
        // Main category accordion
        const details = document.createElement('details');
        details.className = 'menu-acc reveal';
        const sum = document.createElement('summary');
        sum.className = 'menu-sum';
        sum.innerHTML = `<span class="badge">${cat.badge}</span><h3>${cat.title}</h3><svg class="chev" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m6 9 6 6 6-6"/></svg>`;
        details.appendChild(sum);

        const body = document.createElement('div');
        body.className = 'menu-body';

        // Handle direct items (for categories without groups)
        if(cat.items){
          cat.items.forEach(it=>{
            const row = document.createElement('div');
            row.className = 'menu-item';
            row.innerHTML = `<div class="mi-left">${it.name} <span class="meta">${it.desc||""}</span></div>
  <div class="mi-right">
    <div class="price">${it.price||""}</div>
    ${it.photo?`<button type="button" class="photo-btn" data-photo="${it.photo}"
      data-caption="${it.name}"><svg viewBox="0 0 24 24" aria-hidden="true" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg> Foto</button>`:""}
  </div>
`;
            body.appendChild(row);
          });
        }

        // Handle groups (for categories with subcategories)
        if(cat.groups){
          cat.groups.forEach(gr=>{
            if(gr.collapsed) {
              // Create sub-accordion for collapsed groups
              const subDetails = document.createElement('details');
              subDetails.className = 'menu-acc';
              subDetails.style.margin = '8px 0';
              subDetails.style.fontSize = '0.95em';
              
              const subSum = document.createElement('summary');
              subSum.className = 'menu-sum';
              subSum.innerHTML = `<span class="group-title">${gr.title}</span><svg class="chev" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m6 9 6 6 6-6"/></svg>`;
              subDetails.appendChild(subSum);
              
              const subBody = document.createElement('div');
              subBody.className = 'menu-body';
              
              gr.items.forEach(it=>{
                const row = document.createElement('div');
                row.className = 'menu-item';
                row.innerHTML = `<div class="mi-left">${it.name} <span class="meta">${it.desc||""}</span></div>
  <div class="mi-right">
    <div class="price">${it.price||""}</div>
    ${it.photo?`<button type="button" class="photo-btn" data-photo="${it.photo}"
      data-caption="${it.name}"><svg viewBox="0 0 24 24" aria-hidden="true" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg> Foto</button>`:""}
  </div>
`;
                subBody.appendChild(row);
              });
              
              subDetails.appendChild(subBody);
              body.appendChild(subDetails);
            } else {
              // Regular group title + items
              const gt = document.createElement('div');
              gt.className = 'group-title';
              gt.textContent = gr.title;
              body.appendChild(gt);
              gr.items.forEach(it=>{
                const row = document.createElement('div');
                row.className = 'menu-item';
                row.innerHTML = `<div class="mi-left">${it.name} <span class="meta">${it.desc||""}</span></div>
  <div class="mi-right">
    <div class="price">${it.price||""}</div>
    ${it.photo?`<button type="button" class="photo-btn" data-photo="${it.photo}"
      data-caption="${it.name}"><svg viewBox="0 0 24 24" aria-hidden="true" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg> Foto</button>`:""}
  </div>
`;
                body.appendChild(row);
              });
            }
          });
        }

        details.appendChild(body);
        wrap.appendChild(details);
      });
      document.querySelectorAll('.reveal:not(.active)').forEach(el=>io.observe(el));
      if(window.afterMenuRender) window.afterMenuRender();
    }

    /* ========== EVENTI ========== */
    const events = [
     
      { dateISO: '2025-10-02', booking:'soon',  venue: '17/19 URBAN BISTROT', title: 'XXX',               genres: ['XXX'],                      start: 'XX:XX', curatedBy: 'XXX',                headliner: 'XXX',                 guests: ['XXX'],    sponsors: [{text:'XXX'}] },
      { dateISO: '2025-10-03', booking:'soon',  venue: '17/19 URBAN BISTROT', title: 'XXX',               genres: ['XXX'],                      start: 'XX:XX', curatedBy: 'XXX',                headliner: 'XXX',                 guests: ['XXX'],    sponsors: [{text:'XXX'}] },
      { dateISO: '2025-10-04', booking:'soon',  venue: '17/19 URBAN BISTROT', title: 'XXX',               genres: ['XXX'],                      start: 'XX:XX', curatedBy: 'XXX',                headliner: 'XXX',                 guests: ['XXX'],    sponsors: [{text:'XXX'}] },
    ];

    function pickNextEvent(){
      const today = new Date(); today.setHours(0,0,0,0);
      const up = events.filter(e=>!isNaN(new Date(e.dateISO)) && new Date(e.dateISO) >= today)
                       .sort((a,b)=> new Date(a.dateISO)-new Date(b.dateISO));
      return up[0] || events.sort((a,b)=> new Date(a.dateISO)-new Date(b.dateISO))[0];
    }
    function eventId(ev){ return ev.dateISO + '::' + slug(ev.title); }
    function makeNameChip(name, role){
      if(!name) return null;
      const chip = document.createElement('span');
      chip.className = 'name-chip';
      chip.innerHTML = `${role==='headliner' ? '<span class="dot" style="width:8px;height:8px;border-radius:3px;background:var(--fg)"></span>' : ''}${name}`;
      return chip;
    }
    function makeSChip(txt){ const s=document.createElement('span'); s.className='s-chip'; s.textContent=txt; return s; }

    function renderEvents(){
      const list = document.getElementById('eventsList'); if(!list) return;
      list.innerHTML='';
      const sorted = [...events].sort((a,b)=> new Date(a.dateISO)-new Date(b.dateISO)).slice(0,7);
      const toShow = eventsExpanded ? sorted : sorted.slice(0,3);
      toShow.forEach(ev=>{
        const d = new Date(ev.dateISO + 'T12:00:00');
        const day = String(d.getUTCDate()).padStart(2,'0');
        const mon = toMonShort(d);
        const dow = toItDowShort(d).slice(0,3).toUpperCase();
        const eid = eventId(ev);

        const el = document.createElement('div'); el.className='event'; el.dataset.eid = eid;

        // Title
        const title = document.createElement('div');
        title.className = 'event__title';
        title.innerHTML = `<strong>${ev.title}</strong>`;
        el.appendChild(title);

        // Top bar
        const top = document.createElement('div'); top.className = 'event__top';

        const dateBox = document.createElement('div');
        dateBox.className = 'event__date';
        dateBox.innerHTML = `<div class="event__dow">${dow}</div><div class="event__day">${day} ${mon}</div>`;
        top.appendChild(dateBox);

        // CTA prenota (per-evento)
        let cta;
        if(ev.booking==='open'){
          cta = document.createElement('a');
          cta.className = 'pill pill--ghost event__cta';
          cta.href = `https://wa.me/393298252092?text=${encodeURIComponent('Ciao 17/19 Urban Bistrot, vorrei prenotare per: '+ev.title+' • '+formatLongIt(ev.dateISO))}`;
          cta.target = '_blank'; cta.rel = 'noopener'; cta.textContent = 'Prenota';
        }else{
          cta = document.createElement('span');
          cta.className = 'pill pill--ghost pill--disabled event__cta';
          cta.textContent = ev.booking==='soon' ? 'Coming Soon' : 'Prenotazioni chiuse';
        }
        top.appendChild(cta);
        el.appendChild(top);

        // Info row
        const info = document.createElement('div');
        info.className = 'event__info';
        const parts = [ ev.start ? `Start ${ev.start}` : null, ...(ev.genres||[]) ].filter(Boolean);
        info.innerHTML = parts.map(t=>`<span>${t}</span>`).join('');
        el.appendChild(info);

        // Names
        const namesRow = document.createElement('div');
        namesRow.className = 'event__names';
        const head = makeNameChip(ev.headliner, 'headliner'); if(head) namesRow.appendChild(head);
        (ev.guests||[]).forEach(g=>{ const ch = makeNameChip(g, 'guest'); if(ch) namesRow.appendChild(ch); });
        el.appendChild(namesRow);

        // (opz.) Sponsor in card
        if (SHOW_SPONSORS_IN_CARD && ev.sponsors?.length){
          const srow = document.createElement('div'); srow.className = 'event__sponsors';
          ev.sponsors.forEach(s=> s.text && srow.appendChild(makeSChip(s.text)));
          el.appendChild(srow); el.classList.add('event--show-sponsors');
        }

        // Upvote badge (aggregato)
        const vb = document.createElement('div'); vb.className = 'vote-badge'; vb.innerHTML = `${SVG.up}<strong class="n">${Store.getFlameCount(eid)}</strong>`;
        el.appendChild(vb);
        if(Store.getMyFlame(eid)) el.classList.add('event--voted');

        // Actions row (Condividi)
        const actions = document.createElement('div'); actions.className='event__actions';
        const shareBtn = document.createElement('button');
        shareBtn.className='pill pill--ghost';
        shareBtn.innerHTML = `${SVG.share}<span>Condividi</span>`;
        shareBtn.addEventListener('click', (e)=> openShare(el, ev, e.currentTarget));
        actions.appendChild(shareBtn);
        el.appendChild(actions);

        // Double-tap sulla card (toggle flame) + animazione satisfying
        makeDoubleTap(el, ()=>{
          const my = Store.toggleFlame({eid, ctx:{eid, title:ev.title, dateISO:ev.dateISO}});
          el.classList.toggle('event--voted', !!my);
          vb.querySelector('.n').textContent = Store.getFlameCount(eid); // numero aggregato
          if(my){                    // anima solo quando il voto è attivato
            el.classList.remove('event--burst');
            void el.offsetWidth;     // reflow per riarmare l'animazione
            el.classList.add('event--burst');
          }
        });

        list.appendChild(el);
      });

      const btn = document.getElementById('eventsMoreBtn');
      if(sorted.length <= 3){ btn.style.display = 'none'; }
      else { btn.style.display = 'inline-flex'; btn.textContent = eventsExpanded ? 'Mostra meno' : 'Mostra altri'; }
    }

    // Share: Web Share API + fallback popover
    function openShare(cardEl, ev, anchor){
      const text = buildShareText(ev);
      const url = location.href.split('#')[0] + '#events';
      if(navigator.share){
        navigator.share({ title:`17/19 • ${ev.title}`, text, url }).catch(()=>{});
        return;
      }
      let pop = cardEl.querySelector('.share-pop');
      if(!pop){
        pop = document.createElement('div'); pop.className='share-pop';
        pop.innerHTML = `
          <a href="${waUrlFromEvent(ev)}" target="_blank" rel="noopener">WhatsApp</a>
          <a href="${tgUrlFromEvent(ev)}" target="_blank" rel="noopener">Telegram</a>
          <a href="${xUrlFromEvent(ev)}"  target="_blank" rel="noopener">X</a>
          <button type="button" data-cpy>Copia</button>
        `;
        cardEl.appendChild(pop);
        pop.querySelector('[data-cpy]').addEventListener('click', async ()=>{
          try{ await navigator.clipboard.writeText(text+'\n'+url); }catch{}
          pop.style.display='none';
        });
      }
      const r = anchor.getBoundingClientRect(); const pr = cardEl.getBoundingClientRect();
      pop.style.left = (r.left - pr.left) + 'px';
      pop.style.top = (r.bottom - pr.top + 6) + 'px';
      pop.style.display = 'grid';
      document.addEventListener('click', function close(e){
        if(!pop.contains(e.target) && e.target!==anchor){ pop.style.display='none'; document.removeEventListener('click', close, true); }
      }, true);
    }

    function updateEventCountsFromStore(){
      $('#eventsList .event').forEach(el=>{
        const eid = el.dataset.eid;
        el.querySelector('.vote-badge .n').textContent = Store.getFlameCount(eid);
        el.classList.toggle('event--voted', !!Store.getMyFlame(eid));
      });
    }
    function updatePosterChipCounts(){
      if(!posterCanvas) return;
      bouncers.forEach(b=>{
        const name = b.el.dataset.name;
        const cnt = b.el.querySelector('.rc .n');
        if(cnt) cnt.textContent = Store.getRocketsAgg(name);
      });
    }

    /* ===== Init ===== */
    let eventsExpanded = false;
    function bindPosterFromEvent(ev){
      const names = [ev.headliner].concat(ev.guests||[]).filter(Boolean).map(s=>s.toUpperCase());
      posterData.venue    = (ev.venue||'17/19 URBAN BISTROT').toUpperCase();
      posterData.series   = (ev.title||'').toUpperCase();
      posterData.date     = formatPosterDate(ev.dateISO);
      posterData.tagline  = (ev.genres && ev.genres.length ? ev.genres.join(' • ') : 'TECHNO • ELECTRO • VINYL').toUpperCase();
      posterData.curatedBy= ('Curated by ' + (ev.curatedBy || 'Resident DJs')).toUpperCase();
      posterData.logos    = (ev.sponsors || []).map(s => ({text:(s.text||'').toUpperCase()}));
      currentPosterEventCtx = {eid: eventId(ev), title: ev.title, dateISO: ev.dateISO};
      setPosterTexts(posterData);
      if(SHOW_POSTER) {
        initBouncers(names.slice(0,3)); // fino a 3 nomi nel poster
        updatePosterChipCounts();
      }
    }

    function setupHeroDisplay(){
      const posterFrame = document.getElementById('posterFrame');
      const liveCarousel = document.getElementById('liveCarousel');
      
      if(SHOW_POSTER) {
        posterFrame.style.display = '';
        liveCarousel.style.display = 'none';
      } else {
        posterFrame.style.display = 'none';
        liveCarousel.style.display = '';
        setupLiveCarousel();
      }
    }

    function renderEverything(){
      renderMenu();
      renderEvents();
      bindPosterFromEvent(pickNextEvent());
      setupHeroDisplay();
      $('#eventsMoreBtn').addEventListener('click', ()=>{ eventsExpanded = !eventsExpanded; renderEvents(); updateEventCountsFromStore(); });
    }
    renderEverything();

    /* ===== Foto prodotto: modal ===== */
    (function(){
      // Lazy query helpers so this works even if modal is defined after the script.
      function els(){
        return {
          modal: document.getElementById('photoModal'),
          img: document.getElementById('modalPhoto'),
          cap: document.getElementById('modalCaption')
        };
      }
      function ensureImgAttrs(img){
        if(!img) return;
        img.setAttribute('loading','lazy');
        img.setAttribute('decoding','async');
        img.setAttribute('fetchpriority','low');
      }
      
      function openModal(src, caption){
        const {modal, img, cap} = els();
        if(!modal || !img || !cap) return;
        ensureImgAttrs(img);
        // local loader
        let ml = modal.querySelector('.loader-overlay');
        if(!ml){
          ml = document.createElement('div'); ml.className='loader-overlay';
          ml.innerHTML='<span class="loader--ring" aria-hidden="true"></span>';
          modal.querySelector('.modal__body').appendChild(ml);
        }
        ml.classList.remove('hidden');
        img.style.opacity='0';
        img.onload = ()=>{ img.style.opacity='1'; ml.classList.add('hidden'); };
        img.src = src;
        cap.textContent = caption || '';
        modal.classList.add('show');
        modal.setAttribute('aria-hidden','false');
      }

      function closeModal(){
        const {modal, img, cap} = els();
        if(!modal) return;
        modal.classList.remove('show');
        modal.setAttribute('aria-hidden','true');
        if(img) img.src = '';
        if(cap) cap.textContent = '';
      }
    
            // Chiudi e ripristina qualunque stato del modal (come la X, ma più robusto)
        function closeModalHard(){
        const {modal, img, cap} = els();
        if(!modal) return;

        // Stato visivo/ARIA
        modal.classList.remove('show');
        modal.setAttribute('aria-hidden','true');

        // Reset immagine e caption
        if(img){
            img.onload = null;
            img.style.opacity = '';
            // rimuovo completamente la src per evitare frame “fantasma”
            img.removeAttribute('src');
        }
        if(cap) cap.textContent = '';

        // Nascondo eventuale loader
        const ml = modal.querySelector('.loader-overlay');
        if(ml) ml.classList.add('hidden');

        // Sblocco eventuali lock di pointer-events
        modal.style.pointerEvents = 'none';
        requestAnimationFrame(()=>{ modal.style.pointerEvents = ''; });
        }

      // Single delegated click handler
      document.addEventListener('click', function(e){
        // Open from photo button (or its children)
        var btn = e.target && e.target.closest ? e.target.closest('.photo-btn') : null;
        if(btn){
          e.preventDefault();
          var src = btn.getAttribute('data-photo');
          var caption = btn.getAttribute('data-caption');
          if(src) openModal(src, caption);
          return;
        }
        // Close if clicking the X
        if(e.target && e.target.closest && e.target.closest('.modal__close')){
          e.preventDefault();
          closeModal();
          return;
        }
       // Close if clicking on overlay (fuori dal contenuto): comportati come la X
var overlay = e.target && e.target.closest ? e.target.closest('#photoModal') : null;
if(overlay && !e.target.closest('.modal__body')){
  e.preventDefault();
  e.stopPropagation();
  closeModalHard();
  return;
}

// Close se clic sulla X esplicita
if(e.target && e.target.closest && e.target.closest('.modal__close')){
  e.preventDefault();
  e.stopPropagation();
  closeModalHard();
  return;
}

      });

      // ESC closes
      window.addEventListener('keydown', function(e){
        if(e.key === 'Escape'){ closeModal(); }
      });
    })();
;

    /* ===== Smooth scroll con offset header ===== */
    (function(){
      function scrollWithOffset(targetId){
        const el = document.querySelector(targetId);
        if(!el) return;
        const headerH = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--header-h')) || 64;
        const y = el.getBoundingClientRect().top + window.pageYOffset - (headerH + 8);
        window.scrollTo({ top: y, behavior: 'smooth' });
      }
      document.querySelectorAll('a[href^="#"]').forEach(a=>{
        a.addEventListener('click', function(e){
          const href = this.getAttribute('href');
          if(!href || href.length<2) return;
          const id = href.slice(1);
          const tgt = document.getElementById(id);
          if(tgt){
            e.preventDefault();
            scrollWithOffset('#'+id);
          }
        });
      });
    })();

    /* ===== Animazione fluida apertura/chiusura dei <details> ===== */
    (function(){
      function animateDetails(el){
        if(!el) return;
        el.addEventListener('toggle', ()=>{
          const body = el.querySelector('.menu-body'); if(!body) return;
          body.style.overflow='hidden';
          const start = el.open ? 0 : body.scrollHeight;
          const end   = el.open ? body.scrollHeight : 0;
          const dur = 220;
          const startTime = performance.now();
          function tick(now){
            const t = Math.min(1, (now-startTime)/dur);
            const eased = t<.5 ? 2*t*t : -1+(4-2*t)*t; // easeInOutQuad
            const h = start + (end-start)*eased;
            body.style.maxHeight = h+'px';
            if(t<1) requestAnimationFrame(tick);
            else if(el.open){ body.style.maxHeight=''; body.style.overflow='visible'; }
            else { body.style.maxHeight=''; body.style.overflow='hidden'; }
          }
          requestAnimationFrame(tick);
        });
      }
      document.querySelectorAll('details.menu-acc').forEach(animateDetails);
      // also wrap newly rendered after renderMenu()
      window.afterMenuRender = function(){ document.querySelectorAll('details.menu-acc').forEach(animateDetails); }
    })();

  

  // Global loader helpers (optional use)
  window.Loader = {
    el: null,
    ensure(){ if(!this.el){ this.el = document.getElementById('globalLoader'); } return this.el; },
    show(){ const el=this.ensure(); if(el){ el.style.display='grid'; } },
    hide(){ const el=this.ensure(); if(el){ el.style.display='none'; } }
  };
</script>

  <script>
  /* Universal viewport unit fix (iOS & mobile browsers) */
  (function(){
    function setVH(){
      const vh = window.innerHeight * 0.01;
      document.documentElement.style.setProperty('--vh', `${vh}px`);
    }
    setVH();
    window.addEventListener('resize', setVH, { passive:true });
    window.addEventListener('orientationchange', setVH);
    // Ricalcolo “tardivo” per la barra URL mobile
    let t; window.addEventListener('scroll', function(){
      clearTimeout(t); t = setTimeout(setVH, 120);
    }, { passive:true });
  })();
</script>


  <!-- Product Photo Modal -->
  <div class="modal" id="photoModal" aria-hidden="true">
    <div class="modal__body">
      <button class="modal__close" type="button" aria-label="Chiudi">×</button>
      <img id="modalPhoto" alt="Foto prodotto">
      <div id="modalCaption" class="modal__caption meta"></div>
    </div>
  </div>


  <!-- Global loader (hidden by default) -->
  <div id="globalLoader" style="position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.35);z-index:1300">
    <span class="loader--ring" aria-label="Caricamento"></span>
  </div>


<script id="visual-hotfixes-v7e-js">
(function(){
  // --- Build a resilient photo modal if the page doesn't include one ---
  var existing = document.getElementById("photoModal");
  if(!existing){
    var m = document.createElement("div");
    m.className = "modal";
    m.id = "photoModal";
    m.setAttribute("role","dialog");
    m.setAttribute("aria-modal","true");
    m.innerHTML = '<div class="modal-inner" style="display:grid;place-items:center;width:100%;height:100%;">\
      <div class="photo-frame">\
        <button class="close-btn" data-close aria-label="Chiudi">\
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">\
            <path d="M18 6L6 18M6 6l12 12" stroke="white" stroke-width="2" stroke-linecap="round" />\
          </svg>\
        </button>\
        <img data-photo alt="" />\
        <svg class="spinner" viewBox="0 0 24 24" aria-hidden="true">\
          <path fill="currentColor" d="M9 3h6l1.4 2H21a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1h-2.6L15 21H9l-3.4-2H3a1 1 0 0 1-1-1V6a1 1 0 0 1 1-1h2.6L9 3zm3 4a5 5 0 1 0 0 10 5 5 0 0 0 0-10zM5.4 7L4 8.1V16h2.6L9 18h6l2.4-2H20V8.1L18.6 7H5.4zM12 9a3 3 0 1 1 0 6 3 3 0 0 1 0-6z"/>\
        </svg>\
      </div>\
    </div>';
    Object.assign(m.style, {position:"fixed", inset:"0", display:"grid", placeItems:"center", background:"rgba(0,0,0,.55)", zIndex:1200, opacity:"0", visibility:"hidden", transition:"opacity .18s ease"});
    document.body.appendChild(m);
  }
  var modal = document.getElementById("photoModal");
  var imgEl = modal.querySelector('img[data-photo]');

  function openModal(src, alt){
    document.documentElement.classList.add("modal-open");
    document.body.classList.add("modal-open");
    modal.dataset.state = "loading";
    modal.style.visibility = "visible";
    requestAnimationFrame(function(){ modal.style.opacity = "1"; });

    imgEl.style.opacity = "0";
    imgEl.removeAttribute("src"); // reset to avoid showing previous frame
    if(src){
      try{
        imgEl.fetchPriority = "high";
      }catch(e){}
      imgEl.decoding = "async";
      imgEl.alt = alt || "";
      // Load and fade-in when ready
      var done = function(){ modal.dataset.state = "loaded"; imgEl.style.opacity = "1"; };
      imgEl.onload = done;
      imgEl.onerror = done;
      imgEl.src = src;
      if(imgEl.decode) { imgEl.decode().then(done).catch(done); }
    } else {
      modal.dataset.state = "loaded";
    }
  }

  function closeModal(){
    document.documentElement.classList.remove("modal-open");
    document.body.classList.remove("modal-open");
    modal.style.opacity = "0";
    modal.addEventListener("transitionend", function onEnd(){
      modal.removeEventListener("transitionend", onEnd);
      modal.style.visibility = "hidden";
      modal.dataset.state = "";
      imgEl.removeAttribute("src");
    }, {once:true});
  }

  modal.addEventListener("click", function(ev){
    if(ev.target === modal || ev.target.closest("[data-close]")) closeModal();
  });
  window.addEventListener("keydown", function(ev){ if(ev.key === "Escape" && modal.style.visibility === "visible") closeModal(); });

  // Delegate clicks from buttons/links that carry a data-photo-src (or href to image)
  document.addEventListener("click", function(ev){
    var btn = ev.target.closest("[data-photo-src], .photo-btn, [data-open-photo]");
    if(!btn) return;
    var src = btn.getAttribute("data-photo-src") || btn.getAttribute("data-open-photo") || btn.getAttribute("href");
    if(src && /\.(png|jpe?g|webp|avif|gif|svg)(\?.*)?$/i.test(src)){
      ev.preventDefault();
      var alt = btn.getAttribute("data-alt") || btn.getAttribute("aria-label") || "Anteprima";
      openModal(src, alt);
    }
  }, {passive:false});

  // --- Carousel micro-stutter guard: eager-load neighbors & force GPU during gestures ---
  function setupCarousel(root){
    var track = root.querySelector(".track") || root.querySelector("[data-track]") || root;
    // Hardware accel during drag
    var onDown = function(){ track && (track.style.willChange = "transform"); };
    var onUp = function(){ requestAnimationFrame(function(){ if(track) track.style.willChange = "auto"; }); };
    root.addEventListener("pointerdown", onDown);
    root.addEventListener("pointerup", onUp);
    root.addEventListener("pointercancel", onUp);
    // Preload neighbors when a slide becomes visible
    var imgs = root.querySelectorAll("img");
    imgs.forEach(function(im, idx){
      try{ if(idx < 2){ im.loading = "eager"; im.fetchPriority = "high"; } else { im.loading = "lazy"; im.fetchPriority = "low"; } }catch(e){}
      im.decoding = "async";
      if(!im.getAttribute("width") || !im.getAttribute("height")){
        // Avoid layout jump by giving an aspect-ratio if none available
        if(!im.style.aspectRatio) im.style.aspectRatio = "16 / 9";
      }
    });
    var io = new IntersectionObserver(function(entries){
      entries.forEach(function(ent){
        if(ent.isIntersecting){
          var el = ent.target;
          // preload neighbors
          var next = el.nextElementSibling;
          var prev = el.previousElementSibling;
          [next, prev].forEach(function(n){
            if(!n) return;
            var ii = n.tagName === "IMG" ? n : n.querySelector("img");
            if(ii && ii.loading === "lazy"){
              try{ ii.loading = "eager"; ii.fetchPriority = "low"; }catch(e){}
            }
          });
        }
      });
    }, {root: root, threshold: 0.6});
    imgs.forEach(function(im){ io.observe(im); });
  }

  document.querySelectorAll("[data-carousel], .hero-carousel").forEach(setupCarousel);

  // Also apply to any dynamically added carousels
  var mo = new MutationObserver(function(muts){
    muts.forEach(function(m){
      m.addedNodes && m.addedNodes.forEach(function(node){
        if(!(node instanceof Element)) return;
        if(node.matches && (node.matches("[data-carousel]") || node.matches(".hero-carousel"))) setupCarousel(node);
      });
    });
  });
  mo.observe(document.documentElement, {childList:true, subtree:true});
})();
</script>

</body>
</html>
